<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sandbox</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Highlight.js -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        .view-section {
            transition: opacity 0.2s;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            bg: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .katex {
            font-size: 1.1em;
        }

        .chat-message pre {
            margin: 0;
            padding: 0.5rem;
            background: #1a1b26;
            border-radius: 0.5rem;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #374151;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-message pre:hover .copy-btn {
            opacity: 1;
        }

        .run-btn {
            position: absolute;
            top: 5px;
            right: 56px;
            background: #2563eb;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-message pre:hover .run-btn {
            opacity: 1;
        }

        .xterm-viewport {
            overflow-y: hidden !important;
        }

        /* Ubuntu-ish terminal look */
        .xterm, .xterm * {
            font-family: "Ubuntu Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        /* Terminal chrome (borders + subtle depth) */
        #terminals-container > div,
        #agent-terminals-container > div {
            border: 1px solid rgba(148, 163, 184, 0.18);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            background: #300a24;
        }

        /* Make the xterm area blend with the chrome */
        #terminals-container .xterm,
        #agent-terminals-container .xterm {
            padding: 10px;
        }

        /* Nicer scrollbars inside terminals */
        #terminals-container .xterm-viewport::-webkit-scrollbar,
        #agent-terminals-container .xterm-viewport::-webkit-scrollbar {
            width: 10px;
        }
        #terminals-container .xterm-viewport::-webkit-scrollbar-thumb,
        #agent-terminals-container .xterm-viewport::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.25);
            border-radius: 10px;
            border: 2px solid rgba(0, 0, 0, 0);
            background-clip: padding-box;
        }

        /* Resizable terminal viewport wrapper */
        .terminal-resizable {
            resize: both;
            overflow: auto;
            min-width: 320px;
            min-height: 200px;
            max-width: 100%;
            max-height: 100%;
            position: relative;
        }

        /* Agent split panes (chat | terminal) */
        .split-root {
            display: flex;
            flex: 1 1 auto;
            min-height: 0;
            min-width: 0;
        }

        .split-pane {
            min-width: 0;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .split-divider {
            width: 10px;
            cursor: col-resize;
            background: linear-gradient(to bottom, rgba(148, 163, 184, 0.15), rgba(148, 163, 184, 0.05));
            border-left: 1px solid rgba(148, 163, 184, 0.15);
            border-right: 1px solid rgba(148, 163, 184, 0.15);
            flex: 0 0 auto;
            user-select: none;
            touch-action: none;
        }

        .split-divider::after {
            content: "";
            position: absolute;
            width: 4px;
            height: 42px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 6px;
            background: rgba(148, 163, 184, 0.25);
        }

        .split-divider {
            position: relative;
        }

        .agent-terminal-chrome {
            background: radial-gradient(1200px 600px at 20% 0%, rgba(114, 159, 207, 0.18), transparent 60%),
                        radial-gradient(1000px 500px at 80% 100%, rgba(173, 127, 168, 0.12), transparent 55%),
                        #0b1220;
        }

        .agent-pane-surface {
            background: rgba(15, 23, 42, 0.35);
        }

        .agent-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(75, 85, 99, 0.7);
            background: rgba(17, 24, 39, 0.75);
            backdrop-filter: blur(6px);
        }

        .agent-toolbar .hint {
            font-size: 12px;
            color: rgba(203, 213, 225, 0.75);
        }

        .attachment-strip {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .attachment-thumb {
            width: 88px;
            height: 64px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: rgba(15, 23, 42, 0.35);
        }

        .attachment-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .attachment-thumb button {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 999px;
            border: 0;
            background: rgba(15, 23, 42, 0.75);
            color: #e5e7eb;
            cursor: pointer;
            line-height: 20px;
            font-size: 12px;
        }

        /* Unified Settings drawer */
        .settings-overlay {
            position: absolute;
            inset: 0;
            background: rgba(2, 6, 23, 0.6);
            backdrop-filter: blur(2px);
            z-index: 50;
        }

        .settings-drawer {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: min(420px, 92vw);
            background: rgba(17, 24, 39, 0.98);
            border-left: 1px solid rgba(75, 85, 99, 0.7);
            z-index: 60;
            box-shadow: -20px 0 50px rgba(0, 0, 0, 0.35);
        }

        .settings-hidden {
            display: none;
        }

        .chat-message {
            max-width: 80%;
            padding: 10px;
            margin: 5px;
            border-radius: 10px;
            word-wrap: break-word;
        }

        .user-message {
            background-color: rgba(96, 165, 250, 0.22);
            border: 1px solid rgba(96, 165, 250, 0.35);
            align-self: flex-end;
            color: #e6f0ff;
        }

        .ai-message {
            background-color: rgba(148, 163, 184, 0.12);
            border: 1px solid rgba(148, 163, 184, 0.22);
            align-self: flex-start;
            color: #f1f5f9;
        }
    </style>
</head>

<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden">
    <!-- Navbar -->
    <nav class="bg-gray-800 border-b border-gray-700 shrink-0">
        <div class="px-4 py-3 flex justify-between items-center">
            <div class="text-xl font-bold text-blue-500 flex items-center gap-2">
                <span class="md:hidden cursor-pointer text-gray-400"
                    onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">‚ò∞</span>
                Sandbox
            </div>
            <div class="hidden md:flex space-x-1">
                <button onclick="switchMode('dashboard')"
                    class="px-3 py-1 rounded hover:bg-gray-700 text-gray-300 transition"
                    id="nav-dashboard">Dashboard</button>
                <button onclick="switchMode('chat')"
                    class="px-3 py-1 rounded hover:bg-gray-700 text-gray-300 transition" id="nav-chat">Chat</button>
                <button onclick="switchMode('terminal')"
                    class="p-2 rounded hover:bg-gray-700 text-gray-300 transition inline-flex items-center justify-center"
                    id="nav-terminal" title="Terminal" aria-label="Terminal">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5h16v14H4V5z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 9l3 3-3 3" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15h6" />
                    </svg>
                </button>
            </div>
            <div class="flex items-center gap-3 min-w-0">
                <div id="user-badge" class="hidden md:flex flex-col items-end leading-tight min-w-0">
                    <div id="user-name" class="text-sm text-gray-200 font-medium truncate max-w-[20rem]"></div>
                    <div id="user-email" class="text-xs text-gray-400 truncate max-w-[20rem]"></div>
                </div>
                <button id="logout-btn"
                    class="px-3 py-1 bg-red-600 rounded hover:bg-red-700 text-sm font-medium transition">Logout</button>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-gray-800 border-t border-gray-700 p-2 space-y-1">
            <button onclick="switchMode('dashboard')"
                class="block w-full text-left px-3 py-2 rounded hover:bg-gray-700 text-gray-300">Dashboard</button>
            <button onclick="switchMode('chat')"
                class="block w-full text-left px-3 py-2 rounded hover:bg-gray-700 text-gray-300">Chat</button>
            <button onclick="switchMode('terminal')"
                class="block w-full text-left px-3 py-2 rounded hover:bg-gray-700 text-gray-300">Terminal</button>
        </div>
    </nav>

    <!-- Main Content Area (Full Screen) -->
    <div class="flex-grow relative overflow-hidden">

        <!-- Dashboard View -->
        <div id="dashboard-view"
            class="view-section w-full h-full flex flex-col items-center justify-center p-8 text-center">
            <h1
                class="text-4xl font-bold mb-4 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                Welcome to Sandbox</h1>
            <p class="text-gray-400 max-w-md mx-auto mb-8">Your AI-powered development environment. Access the Chat for
                coding assistance or the Terminal for execution.</p>
            <div class="flex gap-4 mb-8">
                <button onclick="switchMode('chat')"
                    class="px-6 py-3 bg-blue-600 rounded-lg hover:bg-blue-700 font-semibold transition">Open
                    Chat</button>
                <button onclick="openAutonomousMode()"
                    class="px-6 py-3 bg-indigo-600 rounded-lg hover:bg-indigo-700 font-semibold transition">Open
                    Autonomous Mode</button>
                <button onclick="switchMode('terminal')"
                    class="px-6 py-3 bg-gray-700 rounded-lg hover:bg-gray-600 font-semibold transition">Open
                    Terminal</button>
            </div>

            <div class="w-full max-w-3xl text-left bg-gray-800/60 border border-gray-700 rounded-2xl p-5 shadow-xl">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-100">Getting started</h2>
                        <p class="text-sm text-gray-400 mt-1">A quick checklist to get productive in under a minute.</p>
                    </div>
                    <button onclick="switchMode('chat'); openSettings();"
                        class="shrink-0 px-3 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm font-medium transition">
                        Provider Settings
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-4">
                    <div class="p-3 rounded-xl bg-gray-900/40 border border-gray-700">
                        <div class="text-sm font-semibold text-gray-200">1) Pick a provider</div>
                        <div class="text-sm text-gray-400 mt-1">Open Chat ‚Üí Settings ‚Üí choose a preset, set Base URL + API key, fetch models.</div>
                    </div>
                    <div class="p-3 rounded-xl bg-gray-900/40 border border-gray-700">
                        <div class="text-sm font-semibold text-gray-200">2) Start chatting</div>
                        <div class="text-sm text-gray-400 mt-1">Use Stop to cancel a response. Attach images or take a screenshot for multimodal prompts.</div>
                    </div>
                    <div class="p-3 rounded-xl bg-gray-900/40 border border-gray-700">
                        <div class="text-sm font-semibold text-gray-200">3) Run commands</div>
                        <div class="text-sm text-gray-400 mt-1">Open Terminal and run shell commands; resize panes as needed.</div>
                    </div>
                    <div class="p-3 rounded-xl bg-gray-900/40 border border-gray-700">
                        <div class="text-sm font-semibold text-gray-200">4) Autonomous mode</div>
                        <div class="text-sm text-gray-400 mt-1">Use ‚ÄúRun in Terminal‚Äù buttons on code blocks and resize chat/terminal split.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="view-section hidden w-full h-full flex overflow-hidden">
            <!-- Sidebar for History (Desktop) -->
            <div class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col hidden md:flex shrink-0">
                <div class="p-3 border-b border-gray-700">
                    <button onclick="startNewChat()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded flex items-center justify-center gap-2 text-sm font-medium transition">
                        <span>+ New Chat</span>
                    </button>
                </div>
                <div id="history-list" class="flex-grow overflow-y-auto p-2 space-y-1"></div>
            </div>

            <!-- Chat Area -->
            <div class="flex-grow flex flex-col h-full bg-gray-900 relative min-w-0">
                <!-- Header -->
                <div
                    class="bg-gray-800 p-3 border-b border-gray-700 flex justify-between items-center shadow-sm shrink-0">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <button onclick="document.querySelector('#chat-view .w-64').classList.toggle('hidden')"
                            class="md:hidden text-gray-400 p-1">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        <h2 class="text-lg font-semibold truncate" id="current-chat-title">New Chat</h2>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="hidden md:flex bg-gray-700/60 rounded-lg p-1">
                            <button id="chat-mode-chat" onclick="setChatMode('chat')"
                                class="px-2 py-1 text-xs rounded-md text-gray-200 hover:bg-white/10 transition">Chat</button>
                            <button id="chat-mode-auto" onclick="setChatMode('autonomous')"
                                class="px-2 py-1 text-xs rounded-md text-gray-200 hover:bg-white/10 transition">Autonomous</button>
                        </div>
                        <button id="chat-terminal-toggle" onclick="toggleAgentTerminalCollapsed()"
                            class="hidden md:inline-flex p-2 rounded-md text-gray-200 hover:bg-white/10 transition"
                            title="Toggle autonomous terminal" aria-label="Toggle autonomous terminal">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5h16v14H4V5z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 9l3 3-3 3" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15h6" />
                            </svg>
                        </button>
                        <button onclick="toggleSettings()"
                            class="text-gray-400 hover:text-white p-1 rounded hover:bg-gray-700 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Settings Drawer (Unified) -->
                <div id="settings-overlay" class="settings-overlay settings-hidden" onclick="closeSettings()"></div>
                <div id="settings-drawer" class="settings-drawer settings-hidden" role="dialog" aria-label="Settings">
                    <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                        <div class="font-semibold text-gray-100">Settings</div>
                        <button onclick="closeSettings()" class="text-gray-400 hover:text-white px-2 py-1 rounded hover:bg-white/10">&times;</button>
                    </div>
                    <div class="p-4 space-y-4 overflow-y-auto" style="max-height: calc(100% - 56px);">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Saved Providers</label>
                                <div class="flex gap-2">
                                    <select id="saved-providers" onchange="loadSelectedProvider(this.value)"
                                        class="flex-grow bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500">
                                        <option value="">Select...</option>
                                    </select>
                                    <button onclick="saveProvider()"
                                        class="bg-green-600 hover:bg-green-700 text-white px-2 rounded text-xs">Save</button>
                                    <button onclick="deleteProvider()"
                                        class="bg-red-600 hover:bg-red-700 text-white px-2 rounded text-xs">Del</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Provider Preset</label>
                                <div class="flex gap-2">
                                    <select id="provider-presets" onchange="applyProviderPreset(this.value)"
                                        class="flex-grow bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500">
                                        <option value="">Select preset...</option>
                                    </select>
                                    <button onclick="applyProviderPreset(document.getElementById('provider-presets').value)"
                                        class="bg-gray-600 hover:bg-gray-700 text-white px-2 rounded text-xs">Apply</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">API Key</label>
                                <input type="password" id="chat-api-key" placeholder="sk-..."
                                    class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500">
                                <div class="text-xs text-gray-500 mt-1">Stored per-user when you click Save.</div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Base URL</label>
                                    <input type="text" id="chat-base-url" placeholder="https://api..."
                                        class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Model</label>
                                    <div class="flex gap-1">
                                        <input type="text" id="chat-model" value="gpt-3.5-turbo"
                                            class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500"
                                            list="model-list">
                                        <datalist id="model-list"></datalist>
                                        <button onclick="fetchModels()"
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-2 rounded text-xs">‚Üª</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-700">
                            <div class="flex items-center justify-between gap-2 mb-2">
                                <div class="font-semibold text-gray-200">MCP</div>
                                <button onclick="addMcpServerPrompt()"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs">+ Add</button>
                            </div>
                            <div class="text-xs text-gray-400 mb-2">
                                Configure MCP servers (URLs + auth). Stored in <code>localStorage</code>. Import/export via <code>mcp.json</code>.
                            </div>
                            <div class="flex gap-2 mb-3">
                                <button onclick="exportMcpConfig()"
                                    class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">Export</button>
                                <input id="mcp-import-input" type="file" accept="application/json" class="hidden" />
                                <button onclick="document.getElementById('mcp-import-input').click()"
                                    class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs">Import</button>
                            </div>
                            <div class="flex gap-2 mb-3">
                                <input id="mcp-direct-url" type="text" placeholder="Direct MCP URL (https://...)"
                                    class="flex-grow bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500">
                                <button onclick="addMcpServerByUrl()"
                                    class="bg-gray-700 hover:bg-gray-600 text-white px-2 rounded text-xs">Add</button>
                            </div>
                            <div id="settings-mcp-server-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

                <div id="chat-standard" class="flex-grow flex flex-col min-h-0">
                    <!-- Messages -->
                    <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4 scroll-smooth">
                        <div id="chat-empty-state" class="text-center text-gray-500 mt-10">
                            <div class="text-lg font-semibold text-gray-300">Start a conversation</div>
                            <div class="text-sm text-gray-500 mt-1">Pick a provider in Settings, then send a message.</div>
                        </div>
                    </div>

                    <!-- Input -->
                    <div class="p-3 bg-gray-800 border-t border-gray-700 shrink-0">
                        <div id="chat-attachments" class="max-w-4xl mx-auto mb-2 hidden"></div>
                        <div class="flex space-x-2 max-w-4xl mx-auto items-center">
                            <textarea id="chat-input" rows="1"
                                class="flex-grow bg-gray-700 px-3 py-2 rounded-lg border border-gray-600 resize-none focus:ring-2 focus:ring-blue-500 focus:outline-none text-white max-h-32"
                                placeholder="Message..."
                                oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                                onkeydown="handleEnter(event)"></textarea>
                            <input id="chat-file-input" type="file" accept="image/*" multiple class="hidden" />
                            <button onclick="document.getElementById('chat-file-input').click()"
                                class="bg-gray-700 h-10 w-10 rounded-lg hover:bg-gray-600 transition inline-flex items-center justify-center text-gray-200"
                                title="Attach images">
                                üìé
                            </button>
                            <button onclick="captureScreenshotToChat()"
                                class="bg-gray-700 h-10 w-10 rounded-lg hover:bg-gray-600 transition inline-flex items-center justify-center text-gray-200"
                                title="Take screenshot">
                                ‚ßâ
                            </button>
                            <button id="chat-stop-btn" onclick="stopChatGeneration()" disabled
                                class="bg-gray-600 h-10 px-3 rounded-lg hover:bg-gray-700 font-bold transition inline-flex items-center justify-center disabled:opacity-40 disabled:cursor-not-allowed"
                                title="Stop generating">
                                Stop
                            </button>
                            <button onclick="sendMessage()"
                                class="bg-blue-600 h-10 w-10 rounded-lg hover:bg-blue-700 font-bold transition inline-flex items-center justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Autonomous mode embedded in Chat view -->
                <div id="chat-autonomous" class="hidden flex-grow min-h-0 flex flex-col">
                    <div id="agent-split-root" class="split-root">
                        <div id="agent-pane-chat" class="split-pane min-h-0 flex flex-col border-r border-gray-700 agent-pane-surface">
                            <div class="flex-grow min-h-0 overflow-hidden">
                                <div id="agent-chat-history" class="h-full p-4 overflow-y-auto space-y-4">
                                    <div id="agent-empty-state" class="text-center text-gray-500 mt-10">
                                        <div class="text-lg font-semibold text-gray-300">Autonomous mode</div>
                                        <div class="text-sm text-gray-500 mt-1">Ask the agent, then use ‚ÄúRun‚Äù on code blocks.</div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-3 bg-gray-800 border-t border-gray-700 shrink-0">
                                <div id="agent-attachments" class="mb-2 hidden"></div>
                                <div class="flex space-x-2 items-end">
                                    <textarea id="agent-chat-input" rows="1"
                                        class="flex-grow bg-gray-700 px-3 py-2 rounded-lg border border-gray-600 resize-none focus:ring-2 focus:ring-blue-500 focus:outline-none text-white max-h-28"
                                        placeholder="Ask agent..."
                                        oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                                        onkeydown="handleAgentEnter(event)"></textarea>
                                    <input id="agent-file-input" type="file" accept="image/*" multiple class="hidden" />
                                    <button onclick="document.getElementById('agent-file-input').click()"
                                        class="bg-gray-700 px-3 py-2 rounded-lg hover:bg-gray-600 transition flex items-center text-gray-200"
                                        title="Attach images">
                                        üìé
                                    </button>
                                    <button onclick="captureScreenshotToAgent()"
                                        class="bg-gray-700 px-3 py-2 rounded-lg hover:bg-gray-600 transition flex items-center text-gray-200"
                                        title="Take screenshot">
                                        ‚ßâ
                                    </button>
                                    <button id="agent-stop-btn" onclick="stopAgentGeneration()" disabled
                                        class="bg-gray-600 px-3 py-2 rounded-lg hover:bg-gray-700 font-bold transition flex items-center disabled:opacity-40 disabled:cursor-not-allowed"
                                        title="Stop generating">
                                        Stop
                                    </button>
                                    <button onclick="sendAgentMessage()"
                                        class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 font-bold transition flex items-center">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="agent-split-divider" class="split-divider" title="Drag to resize panes"></div>
                        <div id="agent-pane-terminal" class="split-pane min-h-0 agent-terminal-chrome flex flex-col">
                            <div class="shrink-0 flex items-center bg-gray-900/60 border-b border-gray-700 overflow-x-auto">
                                <div id="agent-terminal-tabs" class="flex"></div>
                                <button onclick="toggleAgentTerminalCollapsed()"
                                    class="ml-auto px-2 py-2 text-gray-300 hover:text-white hover:bg-white/10 transition font-bold"
                                    title="Collapse terminal" aria-label="Collapse terminal">‚ü∑</button>
                                <button onclick="createTerminalTab({ scope: 'agent' })"
                                    class="px-3 py-2 text-gray-300 hover:text-white hover:bg-white/10 transition font-bold"
                                    title="New Terminal">+</button>
                            </div>
                            <div id="agent-terminals-container" class="flex-grow relative w-full h-full"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terminal View (Multi-Tab) -->
        <div id="terminal-view" class="view-section hidden w-full h-full flex flex-col overflow-hidden bg-black">
            <!-- Tabs Bar -->
            <div class="flex items-center bg-gray-800 border-b border-gray-700 shrink-0 overflow-x-auto">
                <div id="terminal-tabs" class="flex">
                    <!-- Tab Items will be injected here -->
                </div>
                <button onclick="createTerminalTab()"
                    class="px-3 py-2 text-gray-400 hover:text-white hover:bg-gray-700 transition font-bold"
                    title="New Terminal">
                    +
                </button>
            </div>
            <!-- Terminal Containers Area -->
            <div id="terminals-container" class="flex-grow relative w-full h-full">
                <!-- Individual terminal viewports go here -->
            </div>
        </div>

        <!-- Autonomous Mode View removed (now embedded in Chat) -->

    </div>

    <script>
        let supabase;
        // --- Multi-Terminal Logic ---
        let terminals = {}; // { id: { term, fitAddon, ws, containerId, scope } }
        let activeTerminalId = null; // scope: 'main'
        let activeAgentTerminalId = null; // scope: 'agent'
        let terminalCount = 0;

        const DOMPURIFY_CONFIG = {
            USE_PROFILES: { html: true, svg: true, mathMl: true },
            ADD_ATTR: ['data-language', 'data-lang', 'class', 'style']
        };

        function sanitizeHtml(html) {
            if (!window.DOMPurify) return html;
            return window.DOMPurify.sanitize(html, DOMPURIFY_CONFIG);
        }

        function preprocessMathDelimiters(text) {
            if (!text) return text;
            const withStandardDelimiters = text
                .replace(/\\\[/g, '$$')
                .replace(/\\\]/g, '$$')
                .replace(/\\\(/g, '$')
                .replace(/\\\)/g, '$');

            // Many LLMs emit LaTeX with double-escaped backslashes (e.g. "\\frac").
            // KaTeX expects single backslashes inside math, so normalize inside $...$ / $$...$$
            // while leaving code fences/inline code untouched.
            return normalizeMathBackslashes(withStandardDelimiters);
        }

        function normalizeMathBackslashes(markdown) {
            if (!markdown) return markdown;

            const parts = [];
            const fenceRe = /```[\s\S]*?```/g;
            let last = 0;
            let m;
            while ((m = fenceRe.exec(markdown)) !== null) {
                if (m.index > last) parts.push({ type: 'text', value: markdown.slice(last, m.index) });
                parts.push({ type: 'codefence', value: m[0] });
                last = m.index + m[0].length;
            }
            if (last < markdown.length) parts.push({ type: 'text', value: markdown.slice(last) });

            return parts
                .map((part) => {
                    if (part.type !== 'text') return part.value;

                    // Protect inline code spans.
                    const segments = [];
                    const inlineCodeRe = /`[^`]*`/g;
                    let lastSeg = 0;
                    let mi;
                    while ((mi = inlineCodeRe.exec(part.value)) !== null) {
                        if (mi.index > lastSeg) segments.push({ type: 'text', value: part.value.slice(lastSeg, mi.index) });
                        segments.push({ type: 'inlinecode', value: mi[0] });
                        lastSeg = mi.index + mi[0].length;
                    }
                    if (lastSeg < part.value.length) segments.push({ type: 'text', value: part.value.slice(lastSeg) });

                    const fixInner = (inner) => inner.replace(/\\\\(?=[a-zA-Z\\{}_^])/g, '\\');

                    return segments
                        .map((seg) => {
                            if (seg.type !== 'text') return seg.value;

                            // Block math
                            let out = seg.value.replace(/\$\$([\s\S]*?)\$\$/g, (_, inner) => `$$${fixInner(inner)}$$`);

                            // Inline math (best-effort; only normalizes sequences that look like LaTeX commands)
                            out = out.replace(/\$([^\n$]+?)\$/g, (_, inner) => {
                                if (!/\\\\(?=[a-zA-Z\\{}_^])/.test(inner)) return `$${inner}$`;
                                return `$${fixInner(inner)}$`;
                            });

                            return out;
                        })
                        .join('');
                })
                .join('');
        }

        function renderMathInMessage(containerEl) {
            if (!containerEl || typeof renderMathInElement !== 'function') return;
            try {
                renderMathInElement(containerEl, {
                    delimiters: [
                        { left: '$$', right: '$$', display: true },
                        { left: '$', right: '$', display: false }
                    ],
                    throwOnError: false
                });
            } catch (e) {
                console.log('KaTeX render error:', e);
            }
        }

        function renderMarkdownInto(containerEl, markdown) {
            const normalized = preprocessMathDelimiters(markdown || '');
            const html = marked.parse(normalized);
            containerEl.innerHTML = sanitizeHtml(html);
            containerEl.querySelectorAll('pre code').forEach((block) => {
                try { hljs.highlightElement(block); } catch { }
            });
            renderMathInMessage(containerEl);
            wireMessageCodeActions(containerEl);
        }

        function wireMessageCodeActions(containerEl) {
            containerEl.querySelectorAll('pre').forEach((pre) => {
                if (pre.querySelector('.copy-btn')) return;
                const codeEl = pre.querySelector('code');
                if (!codeEl) return;

                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.type = 'button';
                copyBtn.textContent = 'Copy';
                copyBtn.onclick = async () => {
                    try {
                        await navigator.clipboard.writeText(codeEl.innerText);
                        copyBtn.textContent = 'Copied';
                        setTimeout(() => (copyBtn.textContent = 'Copy'), 800);
                    } catch { }
                };

                const runBtn = document.createElement('button');
                runBtn.className = 'run-btn';
                runBtn.type = 'button';
                runBtn.textContent = 'Run';
                runBtn.onclick = async () => {
                    const cmd = codeEl.innerText.replace(/\n+$/, '');
                    if (!cmd) return;
                    const agentVisible = !document.getElementById('chat-view').classList.contains('hidden')
                        && !document.getElementById('chat-autonomous').classList.contains('hidden');
                    await runInTerminal(cmd + '\n', { preferScope: agentVisible ? 'agent' : 'main', autoShow: true });
                };

                pre.appendChild(copyBtn);
                pre.appendChild(runBtn);
            });
        }

        async function runInTerminal(data, { preferScope = 'main', autoShow = false } = {}) {
            const desiredId = preferScope === 'agent' ? activeAgentTerminalId : activeTerminalId;
            if (!desiredId || !terminals[desiredId] || terminals[desiredId].ws.readyState !== WebSocket.OPEN) {
                const newId = createTerminalTab({ scope: preferScope });
                if (preferScope === 'agent') activeAgentTerminalId = newId;
                else activeTerminalId = newId;
            }
            const id = preferScope === 'agent' ? activeAgentTerminalId : activeTerminalId;
            const t = terminals[id];
            if (autoShow) {
                if (preferScope === 'agent') {
                    openAutonomousMode();
                    ensureAgentTerminalVisible();
                } else {
                    switchMode('terminal');
                }
            }
            if (t && t.ws && t.ws.readyState === WebSocket.OPEN) t.ws.send(data);
        }

        function ensureAgentTerminalVisible() {
            const paneTerminal = document.getElementById('agent-pane-terminal');
            if (paneTerminal && paneTerminal.classList.contains('hidden')) toggleAgentTerminalCollapsed();
        }

        function openSettings() {
            const overlay = document.getElementById('settings-overlay');
            const drawer = document.getElementById('settings-drawer');
            if (!overlay || !drawer) return;
            overlay.classList.remove('settings-hidden');
            drawer.classList.remove('settings-hidden');
        }

        function closeSettings() {
            const overlay = document.getElementById('settings-overlay');
            const drawer = document.getElementById('settings-drawer');
            if (!overlay || !drawer) return;
            overlay.classList.add('settings-hidden');
            drawer.classList.add('settings-hidden');
        }

        function toggleSettings() {
            const drawer = document.getElementById('settings-drawer');
            if (!drawer) return;
            const isHidden = drawer.classList.contains('settings-hidden');
            if (isHidden) openSettings();
            else closeSettings();
        }

        async function init() {
            try {
                const res = await fetch('/config');
                const config = await res.json();
                if (!config.supabase_url || !config.supabase_key) throw new Error('Supabase Config Missing');
                supabase = window.supabase.createClient(config.supabase_url, config.supabase_key);

                const { data: { session } } = await supabase.auth.getSession();
                if (!session) { window.location.href = '/'; return; }

                // Logged-in user badge (email + username)
                try {
                    const { data: userData } = await supabase.auth.getUser();
                    const user = userData?.user;
                    if (user) {
                        const username =
                            user.user_metadata?.username ||
                            user.user_metadata?.name ||
                            user.user_metadata?.full_name ||
                            (user.email ? user.email.split('@')[0] : '') ||
                            (user.id ? `user-${String(user.id).slice(0, 8)}` : 'User');
                        const email = user.email || '';
                        const badge = document.getElementById('user-badge');
                        const nameEl = document.getElementById('user-name');
                        const emailEl = document.getElementById('user-email');
                        if (badge) badge.classList.remove('hidden');
                        if (nameEl) nameEl.textContent = username;
                        if (emailEl) emailEl.textContent = email;
                    }
                } catch (e) {
                    console.warn('User badge load failed', e);
                }

                document.getElementById('logout-btn').addEventListener('click', async () => {
                    await supabase.auth.signOut();
                    window.location.href = '/';
                });

                initProviderPresets();
                // Restore last chat mode (chat/autonomous)
                const savedMode = localStorage.getItem('chat_mode_v1') || 'chat';
                setChatMode(savedMode);

                // Multi-modal attachments
                const chatFile = document.getElementById('chat-file-input');
                const agentFile = document.getElementById('agent-file-input');
                if (chatFile) {
                    chatFile.addEventListener('change', (e) => {
                        addAttachmentsFromFiles(e.target.files, 'chat');
                        chatFile.value = '';
                    });
                }
                if (agentFile) {
                    agentFile.addEventListener('change', (e) => {
                        addAttachmentsFromFiles(e.target.files, 'agent');
                        agentFile.value = '';
                    });
                }

                const chatInput = document.getElementById('chat-input');
                if (chatInput) {
                    chatInput.addEventListener('paste', (e) => {
                        const items = e.clipboardData?.items || [];
                        const files = [];
                        for (const it of items) {
                            if (it.kind === 'file') {
                                const f = it.getAsFile();
                                if (f && f.type && f.type.startsWith('image/')) files.push(f);
                            }
                        }
                        if (files.length) {
                            addAttachmentsFromFiles(files, 'chat');
                            e.preventDefault();
                        }
                    });
                }

                const agentInput = document.getElementById('agent-chat-input');
                if (agentInput) {
                    agentInput.addEventListener('paste', (e) => {
                        const items = e.clipboardData?.items || [];
                        const files = [];
                        for (const it of items) {
                            if (it.kind === 'file') {
                                const f = it.getAsFile();
                                if (f && f.type && f.type.startsWith('image/')) files.push(f);
                            }
                        }
                        if (files.length) {
                            addAttachmentsFromFiles(files, 'agent');
                            e.preventDefault();
                        }
                    });
                }

                // MCP import
                const mcpImport = document.getElementById('mcp-import-input');
                if (mcpImport) {
                    mcpImport.addEventListener('change', async (e) => {
                        const file = e.target.files?.[0];
                        if (!file) return;
                        try {
                            await importMcpConfigFromFile(file);
                        } catch (err) {
                            alert(`Failed to import mcp.json: ${err?.message || err}`);
                        } finally {
                            mcpImport.value = '';
                        }
                    });
                }

                // Apply defaults if fields are empty
                if (config.default_base_url && !document.getElementById('chat-base-url').value) {
                    document.getElementById('chat-base-url').value = config.default_base_url;
                }
                if (config.default_api_key && !document.getElementById('chat-api-key').value) {
                    document.getElementById('chat-api-key').value = config.default_api_key;
                }
                if (config.default_model && !document.getElementById('chat-model').value) {
                    document.getElementById('chat-model').value = config.default_model;
                }

                loadProviders();
                await loadChatHistoryList();
                createTerminalTab(); // Init first tab

            } catch (error) { console.error(error); }
        }

        // --- View Switching ---
        function switchMode(mode) {
            const sections = ['dashboard', 'chat', 'terminal'];
            sections.forEach((m) => {
                const el = document.getElementById(`${m}-view`);
                const btn = document.getElementById(`nav-${m}`);
                if (el) el.classList.toggle('hidden', m !== mode);
                if (btn) btn.classList.toggle('bg-gray-700', m === mode);
            });

            if (mode === 'terminal' && activeTerminalId) setTimeout(() => fitTerm(activeTerminalId), 50);

            document.getElementById('mobile-menu').classList.add('hidden');
        }

        // --- Terminal Tabs Logic (supports main + agent scopes) ---
        function createTerminalTab({ scope = 'main' } = {}) {
            terminalCount += 1;
            const id = `term-${scope}-${terminalCount}`;
            const containerId = id;

            const tabsEl = scope === 'agent' ? document.getElementById('agent-terminal-tabs') : document.getElementById('terminal-tabs');
            const containersEl = scope === 'agent' ? document.getElementById('agent-terminals-container') : document.getElementById('terminals-container');

            const tabBtn = document.createElement('button');
            tabBtn.id = `tab-btn-${id}`;
            tabBtn.className = "px-3 py-2 text-sm text-gray-200 hover:bg-white/10 border-r border-gray-700/70 flex items-center gap-2";
            tabBtn.innerHTML = `<span>Term ${terminalCount}</span><span class="text-gray-500 hover:text-red-400" title="Close">√ó</span>`;
            tabBtn.onclick = () => activateTerminalTab(id);
            tabBtn.querySelector('span:last-child').onclick = (e) => closeTerminalTab(id, e);
            tabsEl.appendChild(tabBtn);

            const termDiv = document.createElement('div');
            termDiv.id = containerId;
            termDiv.className = scope === 'agent' ? "absolute inset-0" : "absolute inset-0 terminal-resizable";
            termDiv.style.display = 'none';
            containersEl.appendChild(termDiv);

            const term = new Terminal({
                convertEol: true,
                fontSize: 14,
                cursorBlink: true,
                fontFamily: '"Ubuntu Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',
                theme: {
                    background: "#300a24",
                    foreground: "#eeeeec",
                    cursor: "#eeeeec",
                    cursorAccent: "#300a24",
                    selectionBackground: "rgba(238, 238, 236, 0.25)",
                    black: "#2e3436",
                    red: "#cc0000",
                    green: "#4e9a06",
                    yellow: "#c4a000",
                    blue: "#3465a4",
                    magenta: "#75507b",
                    cyan: "#06989a",
                    white: "#d3d7cf",
                    brightBlack: "#555753",
                    brightRed: "#ef2929",
                    brightGreen: "#8ae234",
                    brightYellow: "#fce94f",
                    brightBlue: "#729fcf",
                    brightMagenta: "#ad7fa8",
                    brightCyan: "#34e2e2",
                    brightWhite: "#eeeeec"
                }
            });
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.open(termDiv);

            const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/terminal`);
            ws.onopen = () => { fitAddon.fit(); };
            ws.onmessage = (event) => { term.write(event.data); };
            ws.onclose = () => { term.write('\r\n[disconnected]\r\n'); };

            term.onData((data) => {
                if (ws.readyState === WebSocket.OPEN) ws.send(data);
            });

            const resizeObserver = new ResizeObserver(() => {
                if (!terminals[id]) return;
                if (termDiv.style.display !== 'none') fitTerm(id);
            });
            resizeObserver.observe(termDiv);

            terminals[id] = { term, fitAddon, ws, containerId, scope, resizeObserver };
            activateTerminalTab(id);
            return id;
        }

        function activateTerminalTab(id) {
            const t = terminals[id];
            if (!t) return;
            const scope = t.scope || 'main';

            Object.keys(terminals).forEach((tid) => {
                const termInfo = terminals[tid];
                const visible = tid === id;
                const el = document.getElementById(termInfo.containerId);
                if (el) el.style.display = visible ? 'block' : 'none';

                const tab = document.getElementById('tab-btn-' + tid);
                if (tab) {
                    tab.classList.toggle('bg-gray-900', !visible);
                    tab.classList.toggle('bg-gray-800', visible);
                    tab.classList.toggle('border-b-2', visible);
                    tab.classList.toggle('border-blue-500', visible);
                }
            });

            if (scope === 'agent') activeAgentTerminalId = id;
            else activeTerminalId = id;

            setTimeout(() => {
                fitTerm(id);
                terminals[id].term.focus();
            }, 50);
        }

        function closeTerminalTab(id, event) {
            if (event) event.stopPropagation();
            const t = terminals[id];
            if (!t) return;
            const scope = t.scope || 'main';

            const remainingInScope = Object.keys(terminals).filter(tid => (terminals[tid].scope || 'main') === scope && tid !== id);
            if (remainingInScope.length === 0) {
                alert("Cannot close the last terminal in this view.");
                return;
            }

            t.ws.close();
            t.term.dispose();
            try { t.resizeObserver?.disconnect?.(); } catch { }
            document.getElementById(t.containerId).remove();
            document.getElementById('tab-btn-' + id).remove();
            delete terminals[id];

            if (scope === 'agent' && activeAgentTerminalId === id) {
                activateTerminalTab(remainingInScope[remainingInScope.length - 1]);
            }
            if (scope === 'main' && activeTerminalId === id) {
                activateTerminalTab(remainingInScope[remainingInScope.length - 1]);
            }
        }

        function fitTerm(id) {
            if (terminals[id]) {
                const { fitAddon, term, ws } = terminals[id];
                try {
                    fitAddon.fit();
                    const cols = term.cols;
                    const rows = term.rows;
                    if (ws.readyState === WebSocket.OPEN) ws.send(`\x01resize:${cols}:${rows}`);
                } catch (e) { console.log("Fit error:", e); }
            }
        }

        function initAgentSplitPane() {
            const root = document.getElementById('agent-split-root');
            const paneChat = document.getElementById('agent-pane-chat');
            const paneTerminal = document.getElementById('agent-pane-terminal');
            const divider = document.getElementById('agent-split-divider');
            if (!root || !paneChat || !paneTerminal || !divider) return;

            const key = 'agent_split_ratio_v1';
            const collapseKey = 'agent_terminal_collapsed_v1';
            const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
            const applyRatio = (ratio) => {
                const r = clamp(ratio, 0.2, 0.8);
                paneChat.style.flex = `0 0 ${Math.round(r * 1000) / 10}%`;
                paneTerminal.style.flex = '1 1 auto';
                // Refit visible terminals (agent + main)
                if (activeAgentTerminalId && !document.getElementById('chat-view').classList.contains('hidden')) {
                    setTimeout(() => fitTerm(activeAgentTerminalId), 0);
                }
            };

            const saved = Number(localStorage.getItem(key));
            if (Number.isFinite(saved) && saved > 0) applyRatio(saved);
            else applyRatio(0.48);

            // Restore collapsed state
            const collapsed = localStorage.getItem(collapseKey) === '1';
            if (collapsed) {
                paneTerminal.classList.add('hidden');
                divider.classList.add('hidden');
                paneChat.style.flex = '1 1 auto';
            }

            let dragging = false;
            const onMove = (clientX) => {
                const rect = root.getBoundingClientRect();
                const ratio = (clientX - rect.left) / rect.width;
                applyRatio(ratio);
                localStorage.setItem(key, String(clamp(ratio, 0.2, 0.8)));
            };

            divider.addEventListener('pointerdown', (e) => {
                dragging = true;
                divider.setPointerCapture(e.pointerId);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });
            divider.addEventListener('pointermove', (e) => {
                if (!dragging) return;
                onMove(e.clientX);
            });
            divider.addEventListener('pointerup', () => {
                dragging = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });

            // Keep split sane on window resize
            window.addEventListener('resize', () => {
                const current = Number(localStorage.getItem(key));
                if (Number.isFinite(current) && current > 0) applyRatio(current);
            });
        }

        function toggleAgentTerminalCollapsed() {
            const paneChat = document.getElementById('agent-pane-chat');
            const paneTerminal = document.getElementById('agent-pane-terminal');
            const divider = document.getElementById('agent-split-divider');
            if (!paneChat || !paneTerminal || !divider) return;
            const key = 'agent_terminal_collapsed_v1';

            const isCollapsed = paneTerminal.classList.contains('hidden');
            if (isCollapsed) {
                paneTerminal.classList.remove('hidden');
                divider.classList.remove('hidden');
                const ratio = Number(localStorage.getItem('agent_split_ratio_v1')) || 0.48;
                paneChat.style.flex = `0 0 ${Math.round(Math.max(0.2, Math.min(0.8, ratio)) * 1000) / 10}%`;
                paneTerminal.style.flex = '1 1 auto';
                localStorage.setItem(key, '0');
                if (activeAgentTerminalId) setTimeout(() => fitTerm(activeAgentTerminalId), 50);
            } else {
                paneTerminal.classList.add('hidden');
                divider.classList.add('hidden');
                paneChat.style.flex = '1 1 auto';
                localStorage.setItem(key, '1');
            }
        }

        function setChatMode(mode) {
            const standard = document.getElementById('chat-standard');
            const auto = document.getElementById('chat-autonomous');
            const btnChat = document.getElementById('chat-mode-chat');
            const btnAuto = document.getElementById('chat-mode-auto');
            const terminalToggle = document.getElementById('chat-terminal-toggle');
            if (!standard || !auto) return;
            const m = mode === 'autonomous' ? 'autonomous' : 'chat';

            standard.classList.toggle('hidden', m === 'autonomous');
            auto.classList.toggle('hidden', m !== 'autonomous');
            if (btnChat) btnChat.classList.toggle('bg-white/10', m === 'chat');
            if (btnAuto) btnAuto.classList.toggle('bg-white/10', m === 'autonomous');
            if (terminalToggle) terminalToggle.classList.toggle('hidden', m !== 'autonomous');

            localStorage.setItem('chat_mode_v1', m);
            if (m === 'autonomous') {
                if (!activeAgentTerminalId) activeAgentTerminalId = createTerminalTab({ scope: 'agent' });
                setTimeout(() => {
                    initAgentSplitPane();
                    if (activeAgentTerminalId) fitTerm(activeAgentTerminalId);
                }, 0);
            }
        }

        function openAutonomousMode() {
            switchMode('chat');
            setChatMode('autonomous');
            ensureAgentTerminalVisible();
        }

        window.addEventListener('resize', () => {
            if (activeTerminalId && !document.getElementById('terminal-view').classList.contains('hidden')) fitTerm(activeTerminalId);
            if (activeAgentTerminalId && !document.getElementById('chat-view').classList.contains('hidden') && !document.getElementById('chat-autonomous').classList.contains('hidden')) fitTerm(activeAgentTerminalId);
        });

        // --- Chat Logic ---
        let chatHistory = [];
        let currentSessionId = null;
        let chatAbortController = null;
        let agentAbortController = null;
        let chatImageAttachments = []; // [{ dataUrl, mime }]
        let agentImageAttachments = []; // [{ dataUrl, mime }]

        function setChatGenerating(isGenerating) {
            const btn = document.getElementById('chat-stop-btn');
            if (!btn) return;
            btn.disabled = !isGenerating;
        }

        function setAgentGenerating(isGenerating) {
            const btn = document.getElementById('agent-stop-btn');
            if (!btn) return;
            btn.disabled = !isGenerating;
        }

        function stopChatGeneration() {
            if (chatAbortController) chatAbortController.abort();
        }

        function stopAgentGeneration() {
            if (agentAbortController) agentAbortController.abort();
        }

        function guessMimeFromDataUrl(dataUrl) {
            const m = /^data:([^;]+);base64,/.exec(dataUrl || '');
            return m ? m[1] : 'image/png';
        }

        function renderAttachmentStrip(containerId, attachments, onRemove) {
            const el = document.getElementById(containerId);
            if (!el) return;
            if (!attachments.length) {
                el.classList.add('hidden');
                el.innerHTML = '';
                return;
            }
            el.classList.remove('hidden');
            el.className = ('attachment-strip ' + (el.className || '')).replace(/\s+/g, ' ').trim();
            el.innerHTML = '';
            attachments.forEach((a, idx) => {
                const wrap = document.createElement('div');
                wrap.className = 'attachment-thumb';
                wrap.innerHTML = `<img alt="attachment" src="${a.dataUrl}">`;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.title = 'Remove';
                btn.textContent = '√ó';
                btn.onclick = () => onRemove(idx);
                wrap.appendChild(btn);
                el.appendChild(wrap);
            });
        }

        function renderChatAttachments() {
            renderAttachmentStrip('chat-attachments', chatImageAttachments, (i) => {
                chatImageAttachments.splice(i, 1);
                renderChatAttachments();
            });
        }

        function renderAgentAttachments() {
            renderAttachmentStrip('agent-attachments', agentImageAttachments, (i) => {
                agentImageAttachments.splice(i, 1);
                renderAgentAttachments();
            });
        }

        function addAttachmentsFromFiles(files, target) {
            const list = Array.from(files || []).filter(f => f && f.type && f.type.startsWith('image/'));
            if (!list.length) return;
            list.forEach((file) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const dataUrl = String(reader.result || '');
                    const entry = { dataUrl, mime: file.type || guessMimeFromDataUrl(dataUrl) };
                    if (target === 'chat') {
                        chatImageAttachments.push(entry);
                        renderChatAttachments();
                    } else {
                        agentImageAttachments.push(entry);
                        renderAgentAttachments();
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        async function captureScreenshotDataUrl() {
            if (!navigator.mediaDevices?.getDisplayMedia) {
                throw new Error('Screen capture not supported in this browser.');
            }
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
            try {
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings?.() || {};
                const video = document.createElement('video');
                video.srcObject = stream;
                video.muted = true;
                await video.play();

                const width = settings.width || video.videoWidth || 1280;
                const height = settings.height || video.videoHeight || 720;
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, width, height);
                return canvas.toDataURL('image/png');
            } finally {
                stream.getTracks().forEach(t => t.stop());
            }
        }

        async function captureScreenshotToChat() {
            try {
                const dataUrl = await captureScreenshotDataUrl();
                chatImageAttachments.push({ dataUrl, mime: 'image/png' });
                renderChatAttachments();
            } catch (e) {
                alert(e?.message || e);
            }
        }

        async function captureScreenshotToAgent() {
            try {
                const dataUrl = await captureScreenshotDataUrl();
                agentImageAttachments.push({ dataUrl, mime: 'image/png' });
                renderAgentAttachments();
            } catch (e) {
                alert(e?.message || e);
            }
        }

        async function startNewChat() {
            currentSessionId = null;
            chatHistory = [];
            document.getElementById('current-chat-title').textContent = "New Chat";
            document.getElementById('chat-history').innerHTML = '';
            document.getElementById('chat-input').value = '';
            if (window.innerWidth < 768) {
                document.querySelector('#chat-view .w-64').classList.add('hidden');
            }
        }

        async function loadChatHistoryList() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;
            const { data, error } = await supabase.from('chat_sessions').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
            if (error) return console.error(error);

            const list = document.getElementById('history-list');
            list.innerHTML = '';
            if (data && data.length > 0) {
                data.forEach(session => {
                    const row = document.createElement('div');
                    row.className = "w-full flex items-center gap-2 p-2 hover:bg-gray-700 rounded text-gray-300 text-sm group mb-1";

                    const titleBtn = document.createElement('button');
                    titleBtn.type = 'button';
                    titleBtn.className = "flex-grow text-left truncate";
                    titleBtn.textContent = session.title || 'Untitled';
                    titleBtn.onclick = () => loadChatSession(session.id, session.title || 'Untitled');

                    const delBtn = document.createElement('button');
                    delBtn.type = 'button';
                    delBtn.className = "shrink-0 opacity-0 group-hover:opacity-100 transition text-gray-400 hover:text-red-300";
                    delBtn.title = "Delete chat";
                    delBtn.onclick = (e) => { e.stopPropagation(); deleteChatSession(session.id); };
                    delBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                            <path fill-rule="evenodd" d="M9 3.75A2.25 2.25 0 0 1 11.25 1.5h1.5A2.25 2.25 0 0 1 15 3.75V4.5h4.5a.75.75 0 0 1 0 1.5h-.75l-1.02 14.28A2.25 2.25 0 0 1 15.486 22.5H8.514a2.25 2.25 0 0 1-2.244-2.22L5.25 6h-.75a.75.75 0 0 1 0-1.5H9V3.75Zm1.5.75V3.75a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 .75.75V4.5h-3ZM8.04 6l.75 13.5a.75.75 0 0 0 .75.75h4.92a.75.75 0 0 0 .75-.75L15.96 6H8.04ZM10.5 9a.75.75 0 0 1 .75.75v7.5a.75.75 0 0 1-1.5 0v-7.5A.75.75 0 0 1 10.5 9Zm3 0a.75.75 0 0 1 .75.75v7.5a.75.75 0 0 1-1.5 0v-7.5A.75.75 0 0 1 13.5 9Z" clip-rule="evenodd" />
                        </svg>`;

                    row.appendChild(titleBtn);
                    row.appendChild(delBtn);
                    list.appendChild(row);
                });
            }
        }

        async function deleteChatSession(sessionId) {
            if (!sessionId) return;
            if (!confirm("Delete this chat? This cannot be undone.")) return;

            try {
                // Delete messages first (if FK constraints exist)
                const { error: msgErr } = await supabase.from('chat_messages').delete().eq('session_id', sessionId);
                if (msgErr) throw msgErr;

                const { error: sessErr } = await supabase.from('chat_sessions').delete().eq('id', sessionId);
                if (sessErr) throw sessErr;

                if (currentSessionId === sessionId) {
                    await startNewChat();
                }
                await loadChatHistoryList();
            } catch (e) {
                console.error(e);
                alert(`Failed to delete chat: ${e?.message || e}`);
            }
        }

        async function loadChatSession(sessionId, title) {
            currentSessionId = sessionId;
            document.getElementById('current-chat-title').textContent = title;
            document.getElementById('chat-history').innerHTML = '<div class="text-center text-gray-500 mt-4">Loading...</div>';
            if (window.innerWidth < 768) document.querySelector('#chat-view .w-64').classList.add('hidden');

            const { data } = await supabase.from('chat_messages').select('*').eq('session_id', sessionId).order('created_at', { ascending: true });
            document.getElementById('chat-history').innerHTML = '';
            chatHistory = [];
            if (data) {
                data.forEach(msg => {
                    addMessageToUI(msg.role === 'user' ? 'user' : 'assistant', msg.content);
                    chatHistory.push({ role: msg.role, content: msg.content });
                });
                scrollToBottom();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message && chatImageAttachments.length === 0) return;
            if (chatAbortController) chatAbortController.abort();

            // Build multimodal user message (text + optional images)
            const parts = [];
            if (message) parts.push({ type: 'text', text: message });
            chatImageAttachments.forEach((a) => {
                parts.push({ type: 'image_url', image_url: { url: a.dataUrl } });
            });
            addMessageToUI('user', message || (chatImageAttachments.length ? '[image]' : ''));
            if (chatImageAttachments.length) {
                const imgWrap = document.createElement('div');
                imgWrap.className = 'attachment-strip mt-2';
                chatImageAttachments.forEach((a) => {
                    const img = document.createElement('img');
                    img.src = a.dataUrl;
                    img.alt = 'attachment';
                    img.className = 'attachment-thumb';
                    img.style.width = '120px';
                    img.style.height = '86px';
                    imgWrap.appendChild(img);
                });
                document.getElementById('chat-history').lastChild.appendChild(imgWrap);
            }
            chatHistory.push({ role: 'user', content: parts.length === 1 && parts[0].type === 'text' ? parts[0].text : parts });
            input.value = '';
            chatImageAttachments = [];
            renderChatAttachments();
            scrollToBottom();

            // Save to DB
            if (!currentSessionId) {
                const { data: { user } } = await supabase.auth.getUser();
                const { data } = await supabase.from('chat_sessions').insert({ user_id: user.id, title: message.substring(0, 30) }).select().single();
                if (data) {
                    currentSessionId = data.id;
                    loadChatHistoryList();
                }
            }
            if (currentSessionId) await supabase.from('chat_messages').insert({ session_id: currentSessionId, role: 'user', content: message || (parts.length ? '[attachment]' : '') });

            // AI Request
            const apiKey = document.getElementById('chat-api-key').value;
            const baseUrl = document.getElementById('chat-base-url').value;
            const model = document.getElementById('chat-model').value;
            const aiMsgEl = addMessageToUI('assistant', '...');
            let aiContent = '';

            try {
                chatAbortController = new AbortController();
                setChatGenerating(true);
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: chatHistory, apiKey, baseUrl, model }),
                    signal: chatAbortController.signal
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                aiMsgEl.innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    aiContent += decoder.decode(value);
                aiMsgEl.innerText = aiContent; // Simple stream render
                scrollToBottom();
                }
                // Final Markdown
                renderMarkdownInto(aiMsgEl, aiContent);

                chatHistory.push({ role: 'assistant', content: aiContent });
                if (currentSessionId) await supabase.from('chat_messages').insert({ session_id: currentSessionId, role: 'assistant', content: aiContent });

            } catch (error) {
                if (error?.name === 'AbortError') {
                    aiMsgEl.textContent = aiContent ? aiContent : "[stopped]";
                } else {
                    aiMsgEl.textContent = "Error: " + error.message;
                }
            } finally {
                setChatGenerating(false);
                chatAbortController = null;
            }
        }

        function addMessageToUI(role, content) {
            const div = document.createElement('div');
            div.className = `chat-message ${role === 'user' ? 'user-message self-end' : 'ai-message self-start'} max-w-[85%] p-3 rounded-xl my-2 prose prose-invert break-words text-sm md:text-base shadow-sm`;
            renderMarkdownInto(div, content);
            const container = document.getElementById('chat-history');
            const empty = document.getElementById('chat-empty-state');
            if (empty) empty.remove();
            container.appendChild(div);
            return div;
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-history');
            container.scrollTop = container.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // --- Autonomous Mode (Agent) ---
        let agentChatHistory = [];
        async function sendAgentMessage() {
            const input = document.getElementById('agent-chat-input');
            const message = (input.value || '').trim();
            if (!message && agentImageAttachments.length === 0) return;
            if (agentAbortController) agentAbortController.abort();

            const parts = [];
            if (message) parts.push({ type: 'text', text: message });
            agentImageAttachments.forEach((a) => {
                parts.push({ type: 'image_url', image_url: { url: a.dataUrl } });
            });

            addAgentMessageToUI('user', message || (agentImageAttachments.length ? '[image]' : ''));
            if (agentImageAttachments.length) {
                const imgWrap = document.createElement('div');
                imgWrap.className = 'attachment-strip mt-2';
                agentImageAttachments.forEach((a) => {
                    const img = document.createElement('img');
                    img.src = a.dataUrl;
                    img.alt = 'attachment';
                    img.className = 'attachment-thumb';
                    img.style.width = '120px';
                    img.style.height = '86px';
                    imgWrap.appendChild(img);
                });
                document.getElementById('agent-chat-history').lastChild.appendChild(imgWrap);
            }
            agentChatHistory.push({ role: 'user', content: parts.length === 1 && parts[0].type === 'text' ? parts[0].text : parts });
            input.value = '';
            agentImageAttachments = [];
            renderAgentAttachments();
            scrollAgentToBottom();

            const apiKey = document.getElementById('chat-api-key').value;
            const baseUrl = document.getElementById('chat-base-url').value;
            const model = document.getElementById('chat-model').value;

            const aiMsgEl = addAgentMessageToUI('assistant', '...');
            let aiContent = '';
            try {
                agentAbortController = new AbortController();
                setAgentGenerating(true);
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: agentChatHistory, apiKey, baseUrl, model }),
                    signal: agentAbortController.signal
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                aiMsgEl.innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    aiContent += decoder.decode(value);
                    aiMsgEl.innerText = aiContent;
                    scrollAgentToBottom();
                }

                renderMarkdownInto(aiMsgEl, aiContent);
                agentChatHistory.push({ role: 'assistant', content: aiContent });
            } catch (error) {
                if (error?.name === 'AbortError') {
                    aiMsgEl.textContent = aiContent ? aiContent : "[stopped]";
                } else {
                    aiMsgEl.textContent = "Error: " + error.message;
                }
            } finally {
                setAgentGenerating(false);
                agentAbortController = null;
            }
        }

        function handleAgentEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAgentMessage();
            }
        }

        function addAgentMessageToUI(role, content) {
            const div = document.createElement('div');
            div.className = `chat-message ${role === 'user' ? 'user-message self-end' : 'ai-message self-start'} max-w-[85%] p-3 rounded-xl my-2 prose prose-invert break-words text-sm md:text-base shadow-sm`;
            renderMarkdownInto(div, content);
            const container = document.getElementById('agent-chat-history');
            const empty = document.getElementById('agent-empty-state');
            if (empty) empty.remove();
            container.appendChild(div);
            return div;
        }

        function scrollAgentToBottom() {
            const container = document.getElementById('agent-chat-history');
            container.scrollTop = container.scrollHeight;
        }

        // --- MCP Admin ---
        const MCP_STORAGE_KEY = 'mcp_servers_v1';

        function loadMcpServers() {
            try {
                return JSON.parse(localStorage.getItem(MCP_STORAGE_KEY) || '[]');
            } catch {
                return [];
            }
        }

        function saveMcpServers(servers) {
            localStorage.setItem(MCP_STORAGE_KEY, JSON.stringify(servers || []));
            renderMcpServers();
        }

        function addMcpServerPrompt() {
            const name = prompt('Server name (e.g., "local-mcp")');
            if (!name) return;
            const url = prompt('Server URL (e.g., "http://localhost:9000")');
            if (!url) return;
            const servers = loadMcpServers();
            servers.push({
                id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
                name,
                url,
                apiKey: '',
                token: '',
                headersJson: '{}',
                toolsJson: '[]'
            });
            saveMcpServers(servers);
        }

        function addMcpServerByUrl() {
            const urlEl = document.getElementById('mcp-direct-url');
            const url = (urlEl?.value || '').trim();
            if (!url) return;
            const name = url.replace(/^https?:\/\//, '').replace(/\/+$/, '');
            const servers = loadMcpServers();
            servers.push({
                id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
                name,
                url,
                apiKey: '',
                token: '',
                headersJson: '{}',
                toolsJson: '[]'
            });
            saveMcpServers(servers);
            if (urlEl) urlEl.value = '';
        }

        function exportMcpConfig() {
            const servers = loadMcpServers().map((s) => {
                let headers = {};
                let tools = [];
                try { headers = s.headersJson ? JSON.parse(s.headersJson) : {}; } catch { headers = {}; }
                try { tools = s.toolsJson ? JSON.parse(s.toolsJson) : []; } catch { tools = []; }
                return {
                    id: s.id,
                    name: s.name,
                    url: s.url,
                    auth: { apiKey: s.apiKey || '', token: s.token || '' },
                    headers,
                    tools
                };
            });
            const payload = { version: 1, servers };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'mcp.json';
            a.click();
            setTimeout(() => URL.revokeObjectURL(a.href), 500);
        }

        async function importMcpConfigFromFile(file) {
            const text = await file.text();
            const parsed = JSON.parse(text);
            const servers = Array.isArray(parsed?.servers) ? parsed.servers : [];
            const normalized = servers.map((s) => ({
                id: s.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())),
                name: s.name || s.id || 'mcp-server',
                url: s.url || '',
                apiKey: s?.auth?.apiKey || '',
                token: s?.auth?.token || '',
                headersJson: JSON.stringify(s.headers || {}, null, 2),
                toolsJson: JSON.stringify(s.tools || [], null, 2)
            })).filter((s) => s.url);
            saveMcpServers(normalized);
        }

        function deleteMcpServer(id) {
            if (!confirm('Delete this MCP server?')) return;
            const servers = loadMcpServers().filter(s => s.id !== id);
            saveMcpServers(servers);
        }

        function updateMcpServer(id, patch) {
            const servers = loadMcpServers().map(s => (s.id === id ? { ...s, ...patch } : s));
            saveMcpServers(servers);
        }

        async function testMcpServer(id, statusElementId = null) {
            const statusEl = document.getElementById(statusElementId || `mcp-status-${id}`);
            const server = loadMcpServers().find(s => s.id === id);
            if (!server) return;
            statusEl.textContent = 'Testing...';

            let extraHeaders = {};
            try {
                extraHeaders = server.headersJson ? JSON.parse(server.headersJson) : {};
            } catch (e) {
                statusEl.textContent = 'Invalid headers JSON';
                return;
            }

            const headers = {
                ...extraHeaders
            };
            if (server.apiKey) headers['x-api-key'] = server.apiKey;
            if (server.token) headers['Authorization'] = `Bearer ${server.token}`;

            try {
                const res = await fetch(server.url, { method: 'GET', headers });
                statusEl.textContent = `HTTP ${res.status}`;
            } catch (e) {
                statusEl.textContent = `Error: ${e.message}`;
            }
        }

        function renderMcpServers() {
            renderMcpServersInto('settings-mcp-server-list', { compact: true });
        }

        function renderMcpServersInto(containerId, { compact } = {}) {
            const list = document.getElementById(containerId);
            if (!list) return;
            const servers = loadMcpServers();
            list.innerHTML = '';
            if (servers.length === 0) {
                list.innerHTML = '<div class="text-gray-400 text-sm">No MCP servers configured.</div>';
                return;
            }

            servers.forEach((s) => {
                const card = document.createElement('div');
                card.className = compact
                    ? 'bg-gray-900/40 border border-gray-700 rounded-lg p-3 space-y-2'
                    : 'bg-gray-800 border border-gray-700 rounded-lg p-4 space-y-3';

                const toolsPreview = (() => {
                    try {
                        const tools = s.toolsJson ? JSON.parse(s.toolsJson) : [];
                        if (!Array.isArray(tools) || tools.length === 0) return '‚Äî';
                        return tools.slice(0, 8).join(', ') + (tools.length > 8 ? '‚Ä¶' : '');
                    } catch {
                        return 'Invalid tools JSON';
                    }
                })();

                card.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <div class="font-semibold truncate">${sanitizeHtml(s.name)}</div>
                            <div class="text-xs text-gray-400 truncate">${sanitizeHtml(s.url)}</div>
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <button class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs" type="button" id="${containerId}-mcp-test-${s.id}">Test</button>
                            <button class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs" type="button" id="${containerId}-mcp-del-${s.id}">Delete</button>
                        </div>
                    </div>
                    <div class="text-xs text-gray-300">Tools: <span class="text-gray-100">${sanitizeHtml(toolsPreview)}</span></div>
                    ${compact ? '' : `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">API Key</label>
                            <input type="password" value="${sanitizeHtml(s.apiKey || '')}" class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500" id="${containerId}-mcp-apikey-${s.id}">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Bearer Token</label>
                            <input type="password" value="${sanitizeHtml(s.token || '')}" class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500" id="${containerId}-mcp-token-${s.id}">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Extra Headers (JSON)</label>
                        <textarea rows="2" class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500 font-mono" id="${containerId}-mcp-headers-${s.id}">${sanitizeHtml(s.headersJson || '{}')}</textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Tools (JSON array)</label>
                        <textarea rows="2" class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500 font-mono" id="${containerId}-mcp-tools-${s.id}">${sanitizeHtml(s.toolsJson || '[]')}</textarea>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-300">Status: <span class="text-gray-100" id="${containerId}-mcp-status-${s.id}">‚Äî</span></div>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs" type="button" id="${containerId}-mcp-save-${s.id}">Save</button>
                    </div>
                    `}
                `;
                list.appendChild(card);

                document.getElementById(`${containerId}-mcp-del-${s.id}`).onclick = () => deleteMcpServer(s.id);
                document.getElementById(`${containerId}-mcp-test-${s.id}`).onclick = () => testMcpServer(s.id, `${containerId}-mcp-status-${s.id}`);
                if (!compact) {
                    document.getElementById(`${containerId}-mcp-save-${s.id}`).onclick = () => {
                        updateMcpServer(s.id, {
                            apiKey: document.getElementById(`${containerId}-mcp-apikey-${s.id}`).value || '',
                            token: document.getElementById(`${containerId}-mcp-token-${s.id}`).value || '',
                            headersJson: document.getElementById(`${containerId}-mcp-headers-${s.id}`).value || '{}',
                            toolsJson: document.getElementById(`${containerId}-mcp-tools-${s.id}`).value || '[]'
                        });
                    };
                }
            });
        }

        // --- Provider & Models (Restored) ---
        // (Assuming existing loadProviders/saveProvider/deleteProvider/fetchModels are preserved or need re-insertion if overwritten. 
        //  The previous replacement block was huge, let's verify if they were cut off. 
        //  Actually, the replacement block ended at `// ... [Include Chat/Provider JS here]`. 
        //  So I must re-add them now.)

        async function fetchModels() { /* ... same as before ... */
            const apiKey = document.getElementById('chat-api-key').value;
            const baseUrl = document.getElementById('chat-base-url').value;
            if (!baseUrl) return alert("Base URL required");

            try {
                const res = await fetch('/api/proxy/models', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ apiKey, baseUrl }) });
                const data = await res.json();
                const list = document.getElementById('model-list');
                list.innerHTML = '';
                const models = data.data || data;
                if (Array.isArray(models)) {
                    models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id || m;
                        list.appendChild(opt);
                    });
                    alert(`Fetched ${models.length} models.`);
                }
            } catch (e) { alert(e.message); }
        }

        const STANDARD_PROVIDERS = [
            { key: 'huggingface-router', name: 'HuggingFace Router', baseUrl: 'https://router.huggingface.co/v1' },
            { key: 'openai', name: 'OpenAI', baseUrl: 'https://api.openai.com/v1' },
            { key: 'openrouter', name: 'OpenRouter', baseUrl: 'https://openrouter.ai/api/v1' },
            { key: 'groq', name: 'Groq (OpenAI-compatible)', baseUrl: 'https://api.groq.com/openai/v1' },
            { key: 'together', name: 'Together', baseUrl: 'https://api.together.xyz/v1' },
            { key: 'fireworks', name: 'Fireworks', baseUrl: 'https://api.fireworks.ai/inference/v1' },
            { key: 'mistral', name: 'Mistral', baseUrl: 'https://api.mistral.ai/v1' },
            { key: 'deepseek', name: 'DeepSeek', baseUrl: 'https://api.deepseek.com/v1' },
        ];

        let providerCache = {}; // name -> { apiKey, baseUrl, model }
        let warnedProviderFallback = false;

        function initProviderPresets() {
            const presets = document.getElementById('provider-presets');
            if (!presets) return;
            presets.innerHTML = '<option value="">Select preset...</option>';
            STANDARD_PROVIDERS.forEach((p) => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.innerText = `${p.name} ‚Äî ${p.baseUrl}`;
                presets.appendChild(opt);
            });
        }

        function applyProviderPreset(key) {
            if (!key) return;
            const preset = STANDARD_PROVIDERS.find((p) => p.key === key);
            if (!preset) return;
            document.getElementById('chat-base-url').value = preset.baseUrl;
        }

        async function getActiveUserId() {
            const { data, error } = await supabase.auth.getUser();
            if (error) throw error;
            return data?.user?.id || null;
        }

        function loadProvidersFromLocalStorage() {
            const select = document.getElementById('saved-providers');
            const saved = JSON.parse(localStorage.getItem('chat_providers') || '{}');
            providerCache = saved;
            select.innerHTML = '<option value="">Select...</option>';
            Object.keys(saved).forEach((k) => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.innerText = k;
                select.appendChild(opt);
            });
        }

        async function loadProviders() {
            try {
                const uid = await getActiveUserId();
                if (!uid) return loadProvidersFromLocalStorage();

                const { data, error } = await supabase
                    .from('provider_configs')
                    .select('name, api_key, base_url, model')
                    .eq('user_id', uid)
                    .order('name', { ascending: true });
                if (error) throw error;

                providerCache = {};
                (data || []).forEach((row) => {
                    providerCache[row.name] = { apiKey: row.api_key || '', baseUrl: row.base_url || '', model: row.model || '' };
                });

                const select = document.getElementById('saved-providers');
                select.innerHTML = '<option value="">Select...</option>';
                Object.keys(providerCache).forEach((k) => {
                    const opt = document.createElement('option');
                    opt.value = k;
                    opt.innerText = k;
                    select.appendChild(opt);
                });
            } catch (e) {
                if (!warnedProviderFallback) {
                    warnedProviderFallback = true;
                    console.warn('Provider configs table missing or RLS blocked; falling back to localStorage.', e);
                }
                loadProvidersFromLocalStorage();
            }
        }

        async function saveProvider() {
            const name = prompt("Name:");
            if (!name) return;

            const config = {
                apiKey: document.getElementById('chat-api-key').value,
                baseUrl: document.getElementById('chat-base-url').value,
                model: document.getElementById('chat-model').value
            };

            try {
                const uid = await getActiveUserId();
                if (!uid) throw new Error('No active user session');

                const { error } = await supabase
                    .from('provider_configs')
                    .upsert(
                        { user_id: uid, name, api_key: config.apiKey, base_url: config.baseUrl, model: config.model },
                        { onConflict: 'user_id,name' }
                    );
                if (error) throw error;
                await loadProviders();
                document.getElementById('saved-providers').value = name;
            } catch (e) {
                // Fallback to local storage if table isn't available.
                const saved = JSON.parse(localStorage.getItem('chat_providers') || '{}');
                saved[name] = config;
                localStorage.setItem('chat_providers', JSON.stringify(saved));
                loadProvidersFromLocalStorage();
                document.getElementById('saved-providers').value = name;
            }
        }

        async function deleteProvider() {
            const name = document.getElementById('saved-providers').value;
            if (!name) return;
            if (!confirm("Delete?")) return;

            try {
                const uid = await getActiveUserId();
                if (!uid) throw new Error('No active user session');

                const { error } = await supabase
                    .from('provider_configs')
                    .delete()
                    .eq('user_id', uid)
                    .eq('name', name);
                if (error) throw error;
                await loadProviders();
            } catch (e) {
                const saved = JSON.parse(localStorage.getItem('chat_providers') || '{}');
                delete saved[name];
                localStorage.setItem('chat_providers', JSON.stringify(saved));
                loadProvidersFromLocalStorage();
            }
        }

        function loadSelectedProvider(name) {
            if (!name) return;
            const config = providerCache[name];
            if (config) {
                document.getElementById('chat-api-key').value = config.apiKey || '';
                document.getElementById('chat-base-url').value = config.baseUrl || '';
                document.getElementById('chat-model').value = config.model || '';
            }
        }

        init();
    </script>
</body>

</html>
