<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sandbox</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <!-- Highlight.js -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        .view-section {
            transition: opacity 0.2s;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            bg: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .katex {
            font-size: 1.1em;
        }

        .chat-message pre {
            margin: 0;
            padding: 0.5rem;
            background: #1a1b26;
            border-radius: 0.5rem;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #374151;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-message pre:hover .copy-btn {
            opacity: 1;
        }

        .run-btn {
            position: absolute;
            top: 5px;
            right: 56px;
            background: #2563eb;
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-message pre:hover .run-btn {
            opacity: 1;
        }

        .xterm-viewport {
            overflow-y: hidden !important;
        }

        /* Ubuntu-ish terminal look */
        .xterm, .xterm * {
            font-family: "Ubuntu Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        /* Resizable terminal viewport wrapper */
        .terminal-resizable {
            resize: both;
            overflow: auto;
            min-width: 320px;
            min-height: 200px;
            max-width: 100%;
            max-height: 100%;
            position: relative;
        }

        /* Agent split panes (chat | terminal) */
        .split-root {
            display: flex;
            flex: 1 1 auto;
            min-height: 0;
            min-width: 0;
        }

        .split-pane {
            min-width: 0;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .split-divider {
            width: 10px;
            cursor: col-resize;
            background: linear-gradient(to bottom, rgba(148, 163, 184, 0.15), rgba(148, 163, 184, 0.05));
            border-left: 1px solid rgba(148, 163, 184, 0.15);
            border-right: 1px solid rgba(148, 163, 184, 0.15);
            flex: 0 0 auto;
            user-select: none;
            touch-action: none;
        }

        .split-divider::after {
            content: "";
            position: absolute;
            width: 4px;
            height: 42px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border-radius: 6px;
            background: rgba(148, 163, 184, 0.25);
        }

        .split-divider {
            position: relative;
        }

        .agent-terminal-chrome {
            background: radial-gradient(1200px 600px at 20% 0%, rgba(114, 159, 207, 0.18), transparent 60%),
                        radial-gradient(1000px 500px at 80% 100%, rgba(173, 127, 168, 0.12), transparent 55%),
                        #0b1220;
        }

        .chat-message {
            max-width: 80%;
            padding: 10px;
            margin: 5px;
            border-radius: 10px;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #3b82f6;
            align-self: flex-end;
            color: white;
        }

        .ai-message {
            background-color: #374151;
            align-self: flex-start;
            color: white;
        }
    </style>
</head>

<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden">
    <!-- Navbar -->
    <nav class="bg-gray-800 border-b border-gray-700 shrink-0">
        <div class="px-4 py-3 flex justify-between items-center">
            <div class="text-xl font-bold text-blue-500 flex items-center gap-2">
                <span class="md:hidden cursor-pointer text-gray-400"
                    onclick="document.getElementById('mobile-menu').classList.toggle('hidden')">☰</span>
                Sandbox
            </div>
            <div class="hidden md:flex space-x-1">
                <button onclick="switchMode('dashboard')"
                    class="px-3 py-1 rounded hover:bg-gray-700 text-gray-300 transition"
                    id="nav-dashboard">Dashboard</button>
                <button onclick="switchMode('chat')"
                    class="px-3 py-1 rounded hover:bg-gray-700 text-gray-300 transition" id="nav-chat">AI Chat</button>
                <button onclick="switchMode('agent')"
                    class="px-3 py-1 rounded hover:bg-gray-700 text-gray-300 transition"
                    id="nav-agent">Autonomous Mode</button>
                <button onclick="switchMode('mcp')"
                    class="px-3 py-1 rounded hover:bg-gray-700 text-gray-300 transition"
                    id="nav-mcp">MCP Admin</button>
                <button onclick="switchMode('terminal')"
                    class="px-3 py-1 rounded hover:bg-gray-700 text-gray-300 transition"
                    id="nav-terminal">Terminal</button>
            </div>
            <button id="logout-btn"
                class="px-3 py-1 bg-red-600 rounded hover:bg-red-700 text-sm font-medium transition">Logout</button>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-gray-800 border-t border-gray-700 p-2 space-y-1">
            <button onclick="switchMode('dashboard')"
                class="block w-full text-left px-3 py-2 rounded hover:bg-gray-700 text-gray-300">Dashboard</button>
            <button onclick="switchMode('chat')"
                class="block w-full text-left px-3 py-2 rounded hover:bg-gray-700 text-gray-300">AI Chat</button>
            <button onclick="switchMode('agent')"
                class="block w-full text-left px-3 py-2 rounded hover:bg-gray-700 text-gray-300">Autonomous
                Mode</button>
            <button onclick="switchMode('mcp')"
                class="block w-full text-left px-3 py-2 rounded hover:bg-gray-700 text-gray-300">MCP Admin</button>
            <button onclick="switchMode('terminal')"
                class="block w-full text-left px-3 py-2 rounded hover:bg-gray-700 text-gray-300">Terminal</button>
        </div>
    </nav>

    <!-- Main Content Area (Full Screen) -->
    <div class="flex-grow relative overflow-hidden">

        <!-- Dashboard View -->
        <div id="dashboard-view"
            class="view-section w-full h-full flex flex-col items-center justify-center p-8 text-center">
            <h1
                class="text-4xl font-bold mb-4 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                Welcome to Sandbox</h1>
            <p class="text-gray-400 max-w-md mx-auto mb-8">Your AI-powered development environment. Access the Chat for
                coding assistance or the Terminal for execution.</p>
            <div class="flex gap-4">
                <button onclick="switchMode('chat')"
                    class="px-6 py-3 bg-blue-600 rounded-lg hover:bg-blue-700 font-semibold transition">Open AI
                    Chat</button>
                <button onclick="switchMode('terminal')"
                    class="px-6 py-3 bg-gray-700 rounded-lg hover:bg-gray-600 font-semibold transition">Open
                    Terminal</button>
            </div>
        </div>

        <!-- Chat View -->
        <div id="chat-view" class="view-section hidden w-full h-full flex overflow-hidden">
            <!-- Sidebar for History (Desktop) -->
            <div class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col hidden md:flex shrink-0">
                <div class="p-3 border-b border-gray-700">
                    <button onclick="startNewChat()"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded flex items-center justify-center gap-2 text-sm font-medium transition">
                        <span>+ New Chat</span>
                    </button>
                </div>
                <div id="history-list" class="flex-grow overflow-y-auto p-2 space-y-1"></div>
            </div>

            <!-- Chat Area -->
            <div class="flex-grow flex flex-col h-full bg-gray-900 relative min-w-0">
                <!-- Header -->
                <div
                    class="bg-gray-800 p-3 border-b border-gray-700 flex justify-between items-center shadow-sm shrink-0">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <button onclick="document.querySelector('#chat-view .w-64').classList.toggle('hidden')"
                            class="md:hidden text-gray-400 p-1">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                        <h2 class="text-lg font-semibold truncate" id="current-chat-title">New Chat</h2>
                    </div>
                    <button onclick="toggleSettings()"
                        class="text-gray-400 hover:text-white p-1 rounded hover:bg-gray-700 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                </div>

                <!-- Settings Modal (Overlay) -->
                <div id="chat-settings"
                    class="hidden absolute top-14 right-4 z-20 w-80 md:w-96 bg-gray-800 p-4 rounded-xl border border-gray-600 shadow-2xl">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
                        <h3 class="font-bold text-gray-200">Settings</h3>
                        <button onclick="toggleSettings()" class="text-gray-400 hover:text-white">&times;</button>
                    </div>
                    <!-- Settings Form (Same as before but tighter) -->
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Saved
                                Providers</label>
                            <div class="flex gap-2">
                                <select id="saved-providers" onchange="loadSelectedProvider(this.value)"
                                    class="flex-grow bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500">
                                    <option value="">Select...</option>
                                </select>
                                <button onclick="saveProvider()"
                                    class="bg-green-600 hover:bg-green-700 text-white px-2 rounded text-xs">Save</button>
                                <button onclick="deleteProvider()"
                                    class="bg-red-600 hover:bg-red-700 text-white px-2 rounded text-xs">Del</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Provider Preset</label>
                            <div class="flex gap-2">
                                <select id="provider-presets" onchange="applyProviderPreset(this.value)"
                                    class="flex-grow bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500">
                                    <option value="">Select preset...</option>
                                </select>
                                <button onclick="applyProviderPreset(document.getElementById('provider-presets').value)"
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-2 rounded text-xs">Apply</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">API Key</label>
                            <input type="password" id="chat-api-key" placeholder="sk-..."
                                class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Base URL</label>
                                <input type="text" id="chat-base-url" placeholder="https://api..."
                                    class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Model</label>
                                <div class="flex gap-1">
                                    <input type="text" id="chat-model" value="gpt-3.5-turbo"
                                        class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500"
                                        list="model-list">
                                    <datalist id="model-list"></datalist>
                                    <button onclick="fetchModels()"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-2 rounded text-xs">↻</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages -->
                <div id="chat-history" class="flex-grow p-4 overflow-y-auto space-y-4 scroll-smooth"></div>

                <!-- Input -->
                <div class="p-3 bg-gray-800 border-t border-gray-700 shrink-0">
                    <div class="flex space-x-2 max-w-4xl mx-auto">
                        <textarea id="chat-input" rows="1"
                            class="flex-grow bg-gray-700 p-3 rounded-lg border border-gray-600 resize-none focus:ring-2 focus:ring-blue-500 focus:outline-none text-white max-h-32"
                            placeholder="Message..."
                            oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                            onkeydown="handleEnter(event)"></textarea>
                        <button id="chat-stop-btn" onclick="stopChatGeneration()" disabled
                            class="bg-gray-600 px-3 rounded-lg hover:bg-gray-700 font-bold transition flex items-center disabled:opacity-40 disabled:cursor-not-allowed"
                            title="Stop generating">
                            Stop
                        </button>
                        <button onclick="sendMessage()"
                            class="bg-blue-600 px-4 rounded-lg hover:bg-blue-700 font-bold transition flex items-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terminal View (Multi-Tab) -->
        <div id="terminal-view" class="view-section hidden w-full h-full flex flex-col overflow-hidden bg-black">
            <!-- Tabs Bar -->
            <div class="flex items-center bg-gray-800 border-b border-gray-700 shrink-0 overflow-x-auto">
                <div id="terminal-tabs" class="flex">
                    <!-- Tab Items will be injected here -->
                </div>
                <button onclick="createTerminalTab()"
                    class="px-3 py-2 text-gray-400 hover:text-white hover:bg-gray-700 transition font-bold"
                    title="New Terminal">
                    +
                </button>
            </div>
            <!-- Terminal Containers Area -->
            <div id="terminals-container" class="flex-grow relative w-full h-full">
                <!-- Individual terminal viewports go here -->
            </div>
        </div>

        <!-- MCP Admin View -->
        <div id="mcp-view" class="view-section hidden w-full h-full overflow-y-auto bg-gray-900">
            <div class="max-w-5xl mx-auto p-4 space-y-4">
                <div class="flex items-center justify-between gap-3">
                    <h2 class="text-xl font-semibold">MCP Admin</h2>
                    <button onclick="addMcpServerPrompt()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-medium transition">+
                        Add Server</button>
                </div>
                <div class="text-xs text-yellow-300 bg-yellow-900/30 border border-yellow-700 rounded p-3">
                    Credentials are stored in `localStorage` on this browser. Avoid using production secrets on shared
                    machines.
                </div>
                <div id="mcp-server-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- Autonomous Mode View -->
        <div id="agent-view" class="view-section hidden w-full h-full flex flex-col overflow-hidden bg-gray-900">
            <div class="shrink-0 p-3 border-b border-gray-700 bg-gray-800 flex items-center justify-between">
                <div class="font-semibold">Autonomous Mode</div>
                <div class="text-xs text-gray-300">Use “Run in Terminal” on code blocks.</div>
            </div>
            <div id="agent-split-root" class="split-root">
                <div id="agent-pane-chat" class="split-pane min-h-0 flex flex-col border-r border-gray-700">
                    <div class="flex-grow min-h-0 overflow-hidden">
                        <div id="agent-chat-history" class="h-full p-4 overflow-y-auto space-y-4"></div>
                    </div>
                    <div class="p-3 bg-gray-800 border-t border-gray-700 shrink-0">
                        <div class="flex space-x-2">
                            <textarea id="agent-chat-input" rows="1"
                                class="flex-grow bg-gray-700 p-3 rounded-lg border border-gray-600 resize-none focus:ring-2 focus:ring-blue-500 focus:outline-none text-white max-h-32"
                                placeholder="Ask agent..."
                                oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                                onkeydown="handleAgentEnter(event)"></textarea>
                            <button id="agent-stop-btn" onclick="stopAgentGeneration()" disabled
                                class="bg-gray-600 px-3 rounded-lg hover:bg-gray-700 font-bold transition flex items-center disabled:opacity-40 disabled:cursor-not-allowed"
                                title="Stop generating">
                                Stop
                            </button>
                            <button onclick="sendAgentMessage()"
                                class="bg-blue-600 px-4 rounded-lg hover:bg-blue-700 font-bold transition flex items-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="agent-split-divider" class="split-divider" title="Drag to resize panes"></div>
                <div id="agent-pane-terminal" class="split-pane min-h-0 agent-terminal-chrome flex flex-col">
                    <div class="shrink-0 flex items-center bg-gray-900/60 border-b border-gray-700 overflow-x-auto">
                        <div id="agent-terminal-tabs" class="flex"></div>
                        <button onclick="createTerminalTab({ scope: 'agent' })"
                            class="px-3 py-2 text-gray-300 hover:text-white hover:bg-white/10 transition font-bold"
                            title="New Terminal">+</button>
                    </div>
                    <div id="agent-terminals-container" class="flex-grow relative w-full h-full"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let supabase;
        // --- Multi-Terminal Logic ---
        let terminals = {}; // { id: { term, fitAddon, ws, containerId, scope } }
        let activeTerminalId = null; // scope: 'main'
        let activeAgentTerminalId = null; // scope: 'agent'
        let terminalCount = 0;

        const DOMPURIFY_CONFIG = {
            USE_PROFILES: { html: true, svg: true, mathMl: true },
            ADD_ATTR: ['data-language', 'data-lang', 'class', 'style']
        };

        function sanitizeHtml(html) {
            if (!window.DOMPurify) return html;
            return window.DOMPurify.sanitize(html, DOMPURIFY_CONFIG);
        }

        function preprocessMathDelimiters(text) {
            if (!text) return text;
            const withStandardDelimiters = text
                .replace(/\\\[/g, '$$')
                .replace(/\\\]/g, '$$')
                .replace(/\\\(/g, '$')
                .replace(/\\\)/g, '$');

            // Many LLMs emit LaTeX with double-escaped backslashes (e.g. "\\frac").
            // KaTeX expects single backslashes inside math, so normalize inside $...$ / $$...$$
            // while leaving code fences/inline code untouched.
            return normalizeMathBackslashes(withStandardDelimiters);
        }

        function normalizeMathBackslashes(markdown) {
            if (!markdown) return markdown;

            const parts = [];
            const fenceRe = /```[\s\S]*?```/g;
            let last = 0;
            let m;
            while ((m = fenceRe.exec(markdown)) !== null) {
                if (m.index > last) parts.push({ type: 'text', value: markdown.slice(last, m.index) });
                parts.push({ type: 'codefence', value: m[0] });
                last = m.index + m[0].length;
            }
            if (last < markdown.length) parts.push({ type: 'text', value: markdown.slice(last) });

            return parts
                .map((part) => {
                    if (part.type !== 'text') return part.value;

                    // Protect inline code spans.
                    const segments = [];
                    const inlineCodeRe = /`[^`]*`/g;
                    let lastSeg = 0;
                    let mi;
                    while ((mi = inlineCodeRe.exec(part.value)) !== null) {
                        if (mi.index > lastSeg) segments.push({ type: 'text', value: part.value.slice(lastSeg, mi.index) });
                        segments.push({ type: 'inlinecode', value: mi[0] });
                        lastSeg = mi.index + mi[0].length;
                    }
                    if (lastSeg < part.value.length) segments.push({ type: 'text', value: part.value.slice(lastSeg) });

                    const fixInner = (inner) => inner.replace(/\\\\(?=[a-zA-Z\\{}_^])/g, '\\');

                    return segments
                        .map((seg) => {
                            if (seg.type !== 'text') return seg.value;

                            // Block math
                            let out = seg.value.replace(/\$\$([\s\S]*?)\$\$/g, (_, inner) => `$$${fixInner(inner)}$$`);

                            // Inline math (best-effort; only normalizes sequences that look like LaTeX commands)
                            out = out.replace(/\$([^\n$]+?)\$/g, (_, inner) => {
                                if (!/\\\\(?=[a-zA-Z\\{}_^])/.test(inner)) return `$${inner}$`;
                                return `$${fixInner(inner)}$`;
                            });

                            return out;
                        })
                        .join('');
                })
                .join('');
        }

        function renderMathInMessage(containerEl) {
            if (!containerEl || typeof renderMathInElement !== 'function') return;
            try {
                renderMathInElement(containerEl, {
                    delimiters: [
                        { left: '$$', right: '$$', display: true },
                        { left: '$', right: '$', display: false }
                    ],
                    throwOnError: false
                });
            } catch (e) {
                console.log('KaTeX render error:', e);
            }
        }

        function renderMarkdownInto(containerEl, markdown) {
            const normalized = preprocessMathDelimiters(markdown || '');
            const html = marked.parse(normalized);
            containerEl.innerHTML = sanitizeHtml(html);
            containerEl.querySelectorAll('pre code').forEach((block) => {
                try { hljs.highlightElement(block); } catch { }
            });
            renderMathInMessage(containerEl);
            wireMessageCodeActions(containerEl);
        }

        function wireMessageCodeActions(containerEl) {
            containerEl.querySelectorAll('pre').forEach((pre) => {
                if (pre.querySelector('.copy-btn')) return;
                const codeEl = pre.querySelector('code');
                if (!codeEl) return;

                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.type = 'button';
                copyBtn.textContent = 'Copy';
                copyBtn.onclick = async () => {
                    try {
                        await navigator.clipboard.writeText(codeEl.innerText);
                        copyBtn.textContent = 'Copied';
                        setTimeout(() => (copyBtn.textContent = 'Copy'), 800);
                    } catch { }
                };

                const runBtn = document.createElement('button');
                runBtn.className = 'run-btn';
                runBtn.type = 'button';
                runBtn.textContent = 'Run';
                runBtn.onclick = async () => {
                    const cmd = codeEl.innerText.replace(/\n+$/, '');
                    if (!cmd) return;
                    const agentVisible = !document.getElementById('agent-view').classList.contains('hidden');
                    await runInTerminal(cmd + '\n', { preferScope: agentVisible ? 'agent' : 'main', autoShow: true });
                };

                pre.appendChild(copyBtn);
                pre.appendChild(runBtn);
            });
        }

        async function runInTerminal(data, { preferScope = 'main', autoShow = false } = {}) {
            const desiredId = preferScope === 'agent' ? activeAgentTerminalId : activeTerminalId;
            if (!desiredId || !terminals[desiredId] || terminals[desiredId].ws.readyState !== WebSocket.OPEN) {
                const newId = createTerminalTab({ scope: preferScope });
                if (preferScope === 'agent') activeAgentTerminalId = newId;
                else activeTerminalId = newId;
            }
            const id = preferScope === 'agent' ? activeAgentTerminalId : activeTerminalId;
            const t = terminals[id];
            if (autoShow) switchMode(preferScope === 'agent' ? 'agent' : 'terminal');
            if (t && t.ws && t.ws.readyState === WebSocket.OPEN) t.ws.send(data);
        }

        function toggleSettings() {
            document.getElementById('chat-settings').classList.toggle('hidden');
        }

        async function init() {
            try {
                const res = await fetch('/config');
                const config = await res.json();
                if (!config.supabase_url || !config.supabase_key) throw new Error('Supabase Config Missing');
                supabase = window.supabase.createClient(config.supabase_url, config.supabase_key);

                const { data: { session } } = await supabase.auth.getSession();
                if (!session) { window.location.href = '/'; return; }

                document.getElementById('logout-btn').addEventListener('click', async () => {
                    await supabase.auth.signOut();
                    window.location.href = '/';
                });

                initProviderPresets();
                initAgentSplitPane();
                // Apply defaults if fields are empty
                if (config.default_base_url && !document.getElementById('chat-base-url').value) {
                    document.getElementById('chat-base-url').value = config.default_base_url;
                }
                if (config.default_api_key && !document.getElementById('chat-api-key').value) {
                    document.getElementById('chat-api-key').value = config.default_api_key;
                }
                if (config.default_model && !document.getElementById('chat-model').value) {
                    document.getElementById('chat-model').value = config.default_model;
                }

                loadProviders();
                await loadChatHistoryList();
                createTerminalTab(); // Init first tab

            } catch (error) { console.error(error); }
        }

        // --- View Switching ---
        function switchMode(mode) {
            const sections = ['dashboard', 'chat', 'terminal', 'mcp', 'agent'];
            sections.forEach((m) => {
                const el = document.getElementById(`${m}-view`);
                const btn = document.getElementById(`nav-${m}`);
                if (el) el.classList.toggle('hidden', m !== mode);
                if (btn) btn.classList.toggle('bg-gray-700', m === mode);
            });

            if (mode === 'terminal' && activeTerminalId) setTimeout(() => fitTerm(activeTerminalId), 50);
            if (mode === 'agent' && activeAgentTerminalId) setTimeout(() => fitTerm(activeAgentTerminalId), 50);
            if (mode === 'mcp') renderMcpServers();

            document.getElementById('mobile-menu').classList.add('hidden');
        }

        // --- Terminal Tabs Logic (supports main + agent scopes) ---
        function createTerminalTab({ scope = 'main' } = {}) {
            terminalCount += 1;
            const id = `term-${scope}-${terminalCount}`;
            const containerId = id;

            const tabsEl = scope === 'agent' ? document.getElementById('agent-terminal-tabs') : document.getElementById('terminal-tabs');
            const containersEl = scope === 'agent' ? document.getElementById('agent-terminals-container') : document.getElementById('terminals-container');

            const tabBtn = document.createElement('button');
            tabBtn.id = `tab-btn-${id}`;
            tabBtn.className = "px-3 py-2 text-sm text-gray-200 hover:bg-white/10 border-r border-gray-700/70 flex items-center gap-2";
            tabBtn.innerHTML = `<span>Term ${terminalCount}</span><span class="text-gray-500 hover:text-red-400" title="Close">×</span>`;
            tabBtn.onclick = () => activateTerminalTab(id);
            tabBtn.querySelector('span:last-child').onclick = (e) => closeTerminalTab(id, e);
            tabsEl.appendChild(tabBtn);

            const termDiv = document.createElement('div');
            termDiv.id = containerId;
            termDiv.className = "absolute inset-0 terminal-resizable";
            termDiv.style.display = 'none';
            containersEl.appendChild(termDiv);

            const term = new Terminal({
                convertEol: true,
                fontSize: 14,
                cursorBlink: true,
                fontFamily: '"Ubuntu Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',
                theme: {
                    background: "#300a24",
                    foreground: "#eeeeec",
                    cursor: "#eeeeec",
                    cursorAccent: "#300a24",
                    selectionBackground: "rgba(238, 238, 236, 0.25)",
                    black: "#2e3436",
                    red: "#cc0000",
                    green: "#4e9a06",
                    yellow: "#c4a000",
                    blue: "#3465a4",
                    magenta: "#75507b",
                    cyan: "#06989a",
                    white: "#d3d7cf",
                    brightBlack: "#555753",
                    brightRed: "#ef2929",
                    brightGreen: "#8ae234",
                    brightYellow: "#fce94f",
                    brightBlue: "#729fcf",
                    brightMagenta: "#ad7fa8",
                    brightCyan: "#34e2e2",
                    brightWhite: "#eeeeec"
                }
            });
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.open(termDiv);

            const ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/terminal`);
            ws.onopen = () => { fitAddon.fit(); };
            ws.onmessage = (event) => { term.write(event.data); };
            ws.onclose = () => { term.write('\r\n[disconnected]\r\n'); };

            term.onData((data) => {
                if (ws.readyState === WebSocket.OPEN) ws.send(data);
            });

            const resizeObserver = new ResizeObserver(() => {
                if (!terminals[id]) return;
                if (termDiv.style.display !== 'none') fitTerm(id);
            });
            resizeObserver.observe(termDiv);

            terminals[id] = { term, fitAddon, ws, containerId, scope, resizeObserver };
            activateTerminalTab(id);
            return id;
        }

        function activateTerminalTab(id) {
            const t = terminals[id];
            if (!t) return;
            const scope = t.scope || 'main';

            Object.keys(terminals).forEach((tid) => {
                const termInfo = terminals[tid];
                const visible = tid === id;
                const el = document.getElementById(termInfo.containerId);
                if (el) el.style.display = visible ? 'block' : 'none';

                const tab = document.getElementById('tab-btn-' + tid);
                if (tab) {
                    tab.classList.toggle('bg-gray-900', !visible);
                    tab.classList.toggle('bg-gray-800', visible);
                    tab.classList.toggle('border-b-2', visible);
                    tab.classList.toggle('border-blue-500', visible);
                }
            });

            if (scope === 'agent') activeAgentTerminalId = id;
            else activeTerminalId = id;

            setTimeout(() => {
                fitTerm(id);
                terminals[id].term.focus();
            }, 50);
        }

        function closeTerminalTab(id, event) {
            if (event) event.stopPropagation();
            const t = terminals[id];
            if (!t) return;
            const scope = t.scope || 'main';

            const remainingInScope = Object.keys(terminals).filter(tid => (terminals[tid].scope || 'main') === scope && tid !== id);
            if (remainingInScope.length === 0) {
                alert("Cannot close the last terminal in this view.");
                return;
            }

            t.ws.close();
            t.term.dispose();
            try { t.resizeObserver?.disconnect?.(); } catch { }
            document.getElementById(t.containerId).remove();
            document.getElementById('tab-btn-' + id).remove();
            delete terminals[id];

            if (scope === 'agent' && activeAgentTerminalId === id) {
                activateTerminalTab(remainingInScope[remainingInScope.length - 1]);
            }
            if (scope === 'main' && activeTerminalId === id) {
                activateTerminalTab(remainingInScope[remainingInScope.length - 1]);
            }
        }

        function fitTerm(id) {
            if (terminals[id]) {
                const { fitAddon, term, ws } = terminals[id];
                try {
                    fitAddon.fit();
                    const cols = term.cols;
                    const rows = term.rows;
                    if (ws.readyState === WebSocket.OPEN) ws.send(`\x01resize:${cols}:${rows}`);
                } catch (e) { console.log("Fit error:", e); }
            }
        }

        function initAgentSplitPane() {
            const root = document.getElementById('agent-split-root');
            const paneChat = document.getElementById('agent-pane-chat');
            const paneTerminal = document.getElementById('agent-pane-terminal');
            const divider = document.getElementById('agent-split-divider');
            if (!root || !paneChat || !paneTerminal || !divider) return;

            const key = 'agent_split_ratio_v1';
            const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
            const applyRatio = (ratio) => {
                const r = clamp(ratio, 0.2, 0.8);
                paneChat.style.flex = `0 0 ${Math.round(r * 1000) / 10}%`;
                paneTerminal.style.flex = '1 1 auto';
                // Refit visible terminals (agent + main)
                if (activeAgentTerminalId && !document.getElementById('agent-view').classList.contains('hidden')) {
                    setTimeout(() => fitTerm(activeAgentTerminalId), 0);
                }
            };

            const saved = Number(localStorage.getItem(key));
            if (Number.isFinite(saved) && saved > 0) applyRatio(saved);
            else applyRatio(0.48);

            let dragging = false;
            const onMove = (clientX) => {
                const rect = root.getBoundingClientRect();
                const ratio = (clientX - rect.left) / rect.width;
                applyRatio(ratio);
                localStorage.setItem(key, String(clamp(ratio, 0.2, 0.8)));
            };

            divider.addEventListener('pointerdown', (e) => {
                dragging = true;
                divider.setPointerCapture(e.pointerId);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            });
            divider.addEventListener('pointermove', (e) => {
                if (!dragging) return;
                onMove(e.clientX);
            });
            divider.addEventListener('pointerup', () => {
                dragging = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });

            // Keep split sane on window resize
            window.addEventListener('resize', () => {
                const current = Number(localStorage.getItem(key));
                if (Number.isFinite(current) && current > 0) applyRatio(current);
            });
        }

        window.addEventListener('resize', () => {
            if (activeTerminalId && !document.getElementById('terminal-view').classList.contains('hidden')) fitTerm(activeTerminalId);
            if (activeAgentTerminalId && !document.getElementById('agent-view').classList.contains('hidden')) fitTerm(activeAgentTerminalId);
        });

        // --- Chat Logic ---
        let chatHistory = [];
        let currentSessionId = null;
        let chatAbortController = null;
        let agentAbortController = null;

        function setChatGenerating(isGenerating) {
            const btn = document.getElementById('chat-stop-btn');
            if (!btn) return;
            btn.disabled = !isGenerating;
        }

        function setAgentGenerating(isGenerating) {
            const btn = document.getElementById('agent-stop-btn');
            if (!btn) return;
            btn.disabled = !isGenerating;
        }

        function stopChatGeneration() {
            if (chatAbortController) chatAbortController.abort();
        }

        function stopAgentGeneration() {
            if (agentAbortController) agentAbortController.abort();
        }

        async function startNewChat() {
            currentSessionId = null;
            chatHistory = [];
            document.getElementById('current-chat-title').textContent = "New Chat";
            document.getElementById('chat-history').innerHTML = '';
            document.getElementById('chat-input').value = '';
            if (window.innerWidth < 768) {
                document.querySelector('#chat-view .w-64').classList.add('hidden');
            }
        }

        async function loadChatHistoryList() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;
            const { data, error } = await supabase.from('chat_sessions').select('*').eq('user_id', user.id).order('created_at', { ascending: false });
            if (error) return console.error(error);

            const list = document.getElementById('history-list');
            list.innerHTML = '';
            if (data && data.length > 0) {
                data.forEach(session => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-2 hover:bg-gray-700 rounded text-gray-300 text-sm truncate relative group mb-1";
                    btn.innerHTML = `<span onclick="loadChatSession('${session.id}', '${session.title.replace(/'/g, "\\'")}')">${session.title || 'Untitled'}</span>`;
                    list.appendChild(btn);
                });
            }
        }

        async function loadChatSession(sessionId, title) {
            currentSessionId = sessionId;
            document.getElementById('current-chat-title').textContent = title;
            document.getElementById('chat-history').innerHTML = '<div class="text-center text-gray-500 mt-4">Loading...</div>';
            if (window.innerWidth < 768) document.querySelector('#chat-view .w-64').classList.add('hidden');

            const { data } = await supabase.from('chat_messages').select('*').eq('session_id', sessionId).order('created_at', { ascending: true });
            document.getElementById('chat-history').innerHTML = '';
            chatHistory = [];
            if (data) {
                data.forEach(msg => {
                    addMessageToUI(msg.role === 'user' ? 'user' : 'assistant', msg.content);
                    chatHistory.push({ role: msg.role, content: msg.content });
                });
                scrollToBottom();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            if (chatAbortController) chatAbortController.abort();

            addMessageToUI('user', message);
            chatHistory.push({ role: 'user', content: message });
            input.value = '';
            scrollToBottom();

            // Save to DB
            if (!currentSessionId) {
                const { data: { user } } = await supabase.auth.getUser();
                const { data } = await supabase.from('chat_sessions').insert({ user_id: user.id, title: message.substring(0, 30) }).select().single();
                if (data) {
                    currentSessionId = data.id;
                    loadChatHistoryList();
                }
            }
            if (currentSessionId) await supabase.from('chat_messages').insert({ session_id: currentSessionId, role: 'user', content: message });

            // AI Request
            const apiKey = document.getElementById('chat-api-key').value;
            const baseUrl = document.getElementById('chat-base-url').value;
            const model = document.getElementById('chat-model').value;
            const aiMsgEl = addMessageToUI('assistant', '...');
            let aiContent = '';

            try {
                chatAbortController = new AbortController();
                setChatGenerating(true);
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: chatHistory, apiKey, baseUrl, model }),
                    signal: chatAbortController.signal
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                aiMsgEl.innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    aiContent += decoder.decode(value);
                aiMsgEl.innerText = aiContent; // Simple stream render
                scrollToBottom();
                }
                // Final Markdown
                renderMarkdownInto(aiMsgEl, aiContent);

                chatHistory.push({ role: 'assistant', content: aiContent });
                if (currentSessionId) await supabase.from('chat_messages').insert({ session_id: currentSessionId, role: 'assistant', content: aiContent });

            } catch (error) {
                if (error?.name === 'AbortError') {
                    aiMsgEl.textContent = aiContent ? aiContent : "[stopped]";
                } else {
                    aiMsgEl.textContent = "Error: " + error.message;
                }
            } finally {
                setChatGenerating(false);
                chatAbortController = null;
            }
        }

        function addMessageToUI(role, content) {
            const div = document.createElement('div');
            div.className = `chat-message ${role === 'user' ? 'user-message bg-blue-600 self-end' : 'ai-message bg-gray-700 self-start'} max-w-[85%] p-3 rounded-xl my-2 prose prose-invert break-words text-sm md:text-base shadow-sm`;
            renderMarkdownInto(div, content);
            document.getElementById('chat-history').appendChild(div);
            return div;
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-history');
            container.scrollTop = container.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // --- Autonomous Mode (Agent) ---
        let agentChatHistory = [];
        async function sendAgentMessage() {
            const input = document.getElementById('agent-chat-input');
            const message = (input.value || '').trim();
            if (!message) return;
            if (agentAbortController) agentAbortController.abort();

            addAgentMessageToUI('user', message);
            agentChatHistory.push({ role: 'user', content: message });
            input.value = '';
            scrollAgentToBottom();

            const apiKey = document.getElementById('chat-api-key').value;
            const baseUrl = document.getElementById('chat-base-url').value;
            const model = document.getElementById('chat-model').value;

            const aiMsgEl = addAgentMessageToUI('assistant', '...');
            let aiContent = '';
            try {
                agentAbortController = new AbortController();
                setAgentGenerating(true);
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: agentChatHistory, apiKey, baseUrl, model }),
                    signal: agentAbortController.signal
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                aiMsgEl.innerHTML = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    aiContent += decoder.decode(value);
                    aiMsgEl.innerText = aiContent;
                    scrollAgentToBottom();
                }

                renderMarkdownInto(aiMsgEl, aiContent);
                agentChatHistory.push({ role: 'assistant', content: aiContent });
            } catch (error) {
                if (error?.name === 'AbortError') {
                    aiMsgEl.textContent = aiContent ? aiContent : "[stopped]";
                } else {
                    aiMsgEl.textContent = "Error: " + error.message;
                }
            } finally {
                setAgentGenerating(false);
                agentAbortController = null;
            }
        }

        function handleAgentEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAgentMessage();
            }
        }

        function addAgentMessageToUI(role, content) {
            const div = document.createElement('div');
            div.className = `chat-message ${role === 'user' ? 'user-message bg-blue-600 self-end' : 'ai-message bg-gray-700 self-start'} max-w-[85%] p-3 rounded-xl my-2 prose prose-invert break-words text-sm md:text-base shadow-sm`;
            renderMarkdownInto(div, content);
            document.getElementById('agent-chat-history').appendChild(div);
            return div;
        }

        function scrollAgentToBottom() {
            const container = document.getElementById('agent-chat-history');
            container.scrollTop = container.scrollHeight;
        }

        // --- MCP Admin ---
        const MCP_STORAGE_KEY = 'mcp_servers_v1';

        function loadMcpServers() {
            try {
                return JSON.parse(localStorage.getItem(MCP_STORAGE_KEY) || '[]');
            } catch {
                return [];
            }
        }

        function saveMcpServers(servers) {
            localStorage.setItem(MCP_STORAGE_KEY, JSON.stringify(servers || []));
            renderMcpServers();
        }

        function addMcpServerPrompt() {
            const name = prompt('Server name (e.g., "local-mcp")');
            if (!name) return;
            const url = prompt('Server URL (e.g., "http://localhost:9000")');
            if (!url) return;
            const servers = loadMcpServers();
            servers.push({
                id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()),
                name,
                url,
                apiKey: '',
                token: '',
                headersJson: '{}'
            });
            saveMcpServers(servers);
        }

        function deleteMcpServer(id) {
            if (!confirm('Delete this MCP server?')) return;
            const servers = loadMcpServers().filter(s => s.id !== id);
            saveMcpServers(servers);
        }

        function updateMcpServer(id, patch) {
            const servers = loadMcpServers().map(s => (s.id === id ? { ...s, ...patch } : s));
            saveMcpServers(servers);
        }

        async function testMcpServer(id) {
            const statusEl = document.getElementById(`mcp-status-${id}`);
            const server = loadMcpServers().find(s => s.id === id);
            if (!server) return;
            statusEl.textContent = 'Testing...';

            let extraHeaders = {};
            try {
                extraHeaders = server.headersJson ? JSON.parse(server.headersJson) : {};
            } catch (e) {
                statusEl.textContent = 'Invalid headers JSON';
                return;
            }

            const headers = {
                ...extraHeaders
            };
            if (server.apiKey) headers['x-api-key'] = server.apiKey;
            if (server.token) headers['Authorization'] = `Bearer ${server.token}`;

            try {
                const res = await fetch(server.url, { method: 'GET', headers });
                statusEl.textContent = `HTTP ${res.status}`;
            } catch (e) {
                statusEl.textContent = `Error: ${e.message}`;
            }
        }

        function renderMcpServers() {
            const list = document.getElementById('mcp-server-list');
            if (!list) return;
            const servers = loadMcpServers();
            list.innerHTML = '';
            if (servers.length === 0) {
                list.innerHTML = '<div class="text-gray-400 text-sm">No MCP servers configured.</div>';
                return;
            }

            servers.forEach((s) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 border border-gray-700 rounded-lg p-4 space-y-3';
                card.innerHTML = `
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <div class="font-semibold truncate">${sanitizeHtml(s.name)}</div>
                            <div class="text-xs text-gray-400 truncate">${sanitizeHtml(s.url)}</div>
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <button class="bg-gray-700 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs" type="button" id="mcp-test-${s.id}">Test</button>
                            <button class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs" type="button" id="mcp-del-${s.id}">Delete</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">API Key</label>
                            <input type="password" value="${sanitizeHtml(s.apiKey || '')}" class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500" id="mcp-apikey-${s.id}">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Bearer Token</label>
                            <input type="password" value="${sanitizeHtml(s.token || '')}" class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500" id="mcp-token-${s.id}">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-400 mb-1 uppercase">Extra Headers (JSON)</label>
                        <textarea rows="2" class="w-full bg-gray-700 text-sm rounded border border-gray-600 p-2 text-white outline-none focus:border-blue-500 font-mono" id="mcp-headers-${s.id}">${sanitizeHtml(s.headersJson || '{}')}</textarea>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-xs text-gray-300">Status: <span class="text-gray-100" id="mcp-status-${s.id}">—</span></div>
                        <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs" type="button" id="mcp-save-${s.id}">Save</button>
                    </div>
                `;
                list.appendChild(card);

                document.getElementById(`mcp-del-${s.id}`).onclick = () => deleteMcpServer(s.id);
                document.getElementById(`mcp-test-${s.id}`).onclick = () => testMcpServer(s.id);
                document.getElementById(`mcp-save-${s.id}`).onclick = () => {
                    updateMcpServer(s.id, {
                        apiKey: document.getElementById(`mcp-apikey-${s.id}`).value || '',
                        token: document.getElementById(`mcp-token-${s.id}`).value || '',
                        headersJson: document.getElementById(`mcp-headers-${s.id}`).value || '{}'
                    });
                };
            });
        }

        // --- Provider & Models (Restored) ---
        // (Assuming existing loadProviders/saveProvider/deleteProvider/fetchModels are preserved or need re-insertion if overwritten. 
        //  The previous replacement block was huge, let's verify if they were cut off. 
        //  Actually, the replacement block ended at `// ... [Include Chat/Provider JS here]`. 
        //  So I must re-add them now.)

        async function fetchModels() { /* ... same as before ... */
            const apiKey = document.getElementById('chat-api-key').value;
            const baseUrl = document.getElementById('chat-base-url').value;
            if (!baseUrl) return alert("Base URL required");

            try {
                const res = await fetch('/api/proxy/models', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ apiKey, baseUrl }) });
                const data = await res.json();
                const list = document.getElementById('model-list');
                list.innerHTML = '';
                const models = data.data || data;
                if (Array.isArray(models)) {
                    models.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id || m;
                        list.appendChild(opt);
                    });
                    alert(`Fetched ${models.length} models.`);
                }
            } catch (e) { alert(e.message); }
        }

        const STANDARD_PROVIDERS = [
            { key: 'huggingface-router', name: 'HuggingFace Router', baseUrl: 'https://router.huggingface.co/v1' },
            { key: 'openai', name: 'OpenAI', baseUrl: 'https://api.openai.com/v1' },
            { key: 'openrouter', name: 'OpenRouter', baseUrl: 'https://openrouter.ai/api/v1' },
            { key: 'groq', name: 'Groq (OpenAI-compatible)', baseUrl: 'https://api.groq.com/openai/v1' },
            { key: 'together', name: 'Together', baseUrl: 'https://api.together.xyz/v1' },
            { key: 'fireworks', name: 'Fireworks', baseUrl: 'https://api.fireworks.ai/inference/v1' },
            { key: 'mistral', name: 'Mistral', baseUrl: 'https://api.mistral.ai/v1' },
            { key: 'deepseek', name: 'DeepSeek', baseUrl: 'https://api.deepseek.com/v1' },
        ];

        let providerCache = {}; // name -> { apiKey, baseUrl, model }
        let warnedProviderFallback = false;

        function initProviderPresets() {
            const presets = document.getElementById('provider-presets');
            if (!presets) return;
            presets.innerHTML = '<option value="">Select preset...</option>';
            STANDARD_PROVIDERS.forEach((p) => {
                const opt = document.createElement('option');
                opt.value = p.key;
                opt.innerText = `${p.name} — ${p.baseUrl}`;
                presets.appendChild(opt);
            });
        }

        function applyProviderPreset(key) {
            if (!key) return;
            const preset = STANDARD_PROVIDERS.find((p) => p.key === key);
            if (!preset) return;
            document.getElementById('chat-base-url').value = preset.baseUrl;
        }

        async function getActiveUserId() {
            const { data, error } = await supabase.auth.getUser();
            if (error) throw error;
            return data?.user?.id || null;
        }

        function loadProvidersFromLocalStorage() {
            const select = document.getElementById('saved-providers');
            const saved = JSON.parse(localStorage.getItem('chat_providers') || '{}');
            providerCache = saved;
            select.innerHTML = '<option value="">Select...</option>';
            Object.keys(saved).forEach((k) => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.innerText = k;
                select.appendChild(opt);
            });
        }

        async function loadProviders() {
            try {
                const uid = await getActiveUserId();
                if (!uid) return loadProvidersFromLocalStorage();

                const { data, error } = await supabase
                    .from('provider_configs')
                    .select('name, api_key, base_url, model')
                    .eq('user_id', uid)
                    .order('name', { ascending: true });
                if (error) throw error;

                providerCache = {};
                (data || []).forEach((row) => {
                    providerCache[row.name] = { apiKey: row.api_key || '', baseUrl: row.base_url || '', model: row.model || '' };
                });

                const select = document.getElementById('saved-providers');
                select.innerHTML = '<option value="">Select...</option>';
                Object.keys(providerCache).forEach((k) => {
                    const opt = document.createElement('option');
                    opt.value = k;
                    opt.innerText = k;
                    select.appendChild(opt);
                });
            } catch (e) {
                if (!warnedProviderFallback) {
                    warnedProviderFallback = true;
                    console.warn('Provider configs table missing or RLS blocked; falling back to localStorage.', e);
                }
                loadProvidersFromLocalStorage();
            }
        }

        async function saveProvider() {
            const name = prompt("Name:");
            if (!name) return;

            const config = {
                apiKey: document.getElementById('chat-api-key').value,
                baseUrl: document.getElementById('chat-base-url').value,
                model: document.getElementById('chat-model').value
            };

            try {
                const uid = await getActiveUserId();
                if (!uid) throw new Error('No active user session');

                const { error } = await supabase
                    .from('provider_configs')
                    .upsert(
                        { user_id: uid, name, api_key: config.apiKey, base_url: config.baseUrl, model: config.model },
                        { onConflict: 'user_id,name' }
                    );
                if (error) throw error;
                await loadProviders();
                document.getElementById('saved-providers').value = name;
            } catch (e) {
                // Fallback to local storage if table isn't available.
                const saved = JSON.parse(localStorage.getItem('chat_providers') || '{}');
                saved[name] = config;
                localStorage.setItem('chat_providers', JSON.stringify(saved));
                loadProvidersFromLocalStorage();
                document.getElementById('saved-providers').value = name;
            }
        }

        async function deleteProvider() {
            const name = document.getElementById('saved-providers').value;
            if (!name) return;
            if (!confirm("Delete?")) return;

            try {
                const uid = await getActiveUserId();
                if (!uid) throw new Error('No active user session');

                const { error } = await supabase
                    .from('provider_configs')
                    .delete()
                    .eq('user_id', uid)
                    .eq('name', name);
                if (error) throw error;
                await loadProviders();
            } catch (e) {
                const saved = JSON.parse(localStorage.getItem('chat_providers') || '{}');
                delete saved[name];
                localStorage.setItem('chat_providers', JSON.stringify(saved));
                loadProvidersFromLocalStorage();
            }
        }

        function loadSelectedProvider(name) {
            if (!name) return;
            const config = providerCache[name];
            if (config) {
                document.getElementById('chat-api-key').value = config.apiKey || '';
                document.getElementById('chat-base-url').value = config.baseUrl || '';
                document.getElementById('chat-model').value = config.model || '';
            }
        }

        init();
    </script>
</body>

</html>
